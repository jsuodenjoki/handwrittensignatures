<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Allekirjoitusgeneraattori</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        overflow: hidden;
        margin: 20px 0;
      }

      .signature-carousel {
        width: 100%;
        overflow: hidden;
      }

      .signature-carousel-inner {
        display: flex;
        animation: carousel 60s linear infinite;
      }

      .carousel-item {
        flex: 0 0 auto;
        padding: 0 20px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      @keyframes carousel {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-2600px);
        }
      }

      /* Lisää oma fontti @font-face-säännöllä */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Allekirjoitusgeneraattori</h1>
    <p>Luo kauniita käsinkirjoitettuja allekirjoituksia helposti</p>

    <!-- Korvaa nykyinen karuselli-elementti tällä staattisella HTML-rakenteella -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <div class="signature-carousel-inner">
          <!-- Kaikki 26 kuvaa -->
          <div class="carousel-item">
            <img
              src="signatures/example_1.png"
              alt="Allekirjoitus 1"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="/signatures/example_2.png"
              alt="Allekirjoitus 2"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="./signatures/example_3.png"
              alt="Allekirjoitus 3"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="./signatures/example_4.png"
              alt="Allekirjoitus 4"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_5.png"
              alt="Allekirjoitus 5"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_6.png"
              alt="Allekirjoitus 6"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_7.png"
              alt="Allekirjoitus 7"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_8.png"
              alt="Allekirjoitus 8"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_9.png"
              alt="Allekirjoitus 9"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_10.png"
              alt="Allekirjoitus 10"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_11.png"
              alt="Allekirjoitus 11"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_12.png"
              alt="Allekirjoitus 12"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_13.png"
              alt="Allekirjoitus 13"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_14.png"
              alt="Allekirjoitus 14"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_15.png"
              alt="Allekirjoitus 15"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_16.png"
              alt="Allekirjoitus 16"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_17.png"
              alt="Allekirjoitus 17"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_18.png"
              alt="Allekirjoitus 18"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_19.png"
              alt="Allekirjoitus 19"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_20.png"
              alt="Allekirjoitus 20"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_21.png"
              alt="Allekirjoitus 21"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_22.png"
              alt="Allekirjoitus 22"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_23.png"
              alt="Allekirjoitus 23"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_24.png"
              alt="Allekirjoitus 24"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_25.png"
              alt="Allekirjoitus 25"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_26.png"
              alt="Allekirjoitus 26"
              style="max-height: 60px"
            />
          </div>

          <!-- Toista ensimmäiset 5 kuvaa saumattoman animaation varmistamiseksi -->
          <div class="carousel-item">
            <img
              src="public/signatures/example_1.png"
              alt="Allekirjoitus 1"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_2.png"
              alt="Allekirjoitus 2"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_3.png"
              alt="Allekirjoitus 3"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_4.png"
              alt="Allekirjoitus 4"
              style="max-height: 60px"
            />
          </div>
          <div class="carousel-item">
            <img
              src="public/signatures/example_5.png"
              alt="Allekirjoitus 5"
              style="max-height: 60px"
            />
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Kirjoita nimesi tähän..."
          style="width: 40%"
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Luo allekirjoitukset
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Osta allekirjoitukset (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Haluatko allekirjoitukset myös sähköpostiisi?</h2>
      <input type="email" id="emailInput" placeholder="Sähköpostiosoitteesi" />
      <button id="sendEmailButton">Lähetä allekirjoitukset sähköpostiin</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <div
      id="download-again-container"
      class="email-container"
      style="display: none"
    >
      <button id="downloadAgainButton" class="button primary-button">
        Lataa allekirjoitukset uudelleen
      </button>
    </div>

    <div id="reset-container" class="email-container" style="display: none">
      <div id="reset-timer" class="status-message">
        Tiedot poistetaan automaattisesti 3:00 minuutin kuluttua
      </div>
      <button id="resetButton" class="button primary-button">
        Luo lisää allekirjoituksia
      </button>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");
      const downloadAgainContainer = document.getElementById(
        "download-again-container"
      );
      const downloadAgainButton = document.getElementById(
        "downloadAgainButton"
      );
      const resetContainer = document.getElementById("reset-container");
      const resetButton = document.getElementById("resetButton");
      const resetTimer = document.getElementById("reset-timer");

      // Fontit allekirjoituksille - alusta tyhjä lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Emma Johnson",
        "James Smith",
        "Olivia Williams",
        "Liam Brown",
        "Sophia Davis",
        "Benjamin Wilson",
        "Charlotte Miller",
        "Ethan Moore",
        "Isabella Taylor",
        "Mason Anderson",
        "Mia Thomas",
        "Alexander Harris",
        "Amelia Martin",
        "Daniel Thompson",
        "Harper White",
        "Henry Clark",
        "Evelyn Rodriguez",
        "Michael Lewis",
        "Abigail Walker",
        "Lucas Hall",
        "Emily Allen",
        "William Young",
        "Scarlett King",
        "Elijah Scott",
        "Grace Wright",
        "Oliver Green",
      ];

      // Tallenna käyttäjän IP-osoite localStorageen
      async function saveClientIp() {
        try {
          const response = await fetch(`${API_URL}/api/get-client-ip`);
          const clientIp = await response.text();
          localStorage.setItem("clientIp", clientIp);
          console.log("IP tallennettu localStorageen:", clientIp);
          return clientIp;
        } catch (error) {
          console.error("Virhe IP:n tallennuksessa:", error);
          return null;
        }
      }

      // Hae tallennettu IP-osoite tai hae uusi
      async function getClientIp() {
        let clientIp = localStorage.getItem("clientIp");
        if (!clientIp) {
          clientIp = await saveClientIp();
        }
        return clientIp;
      }

      // Tallenna maksutila localStorageen
      function savePaymentStatus(isPaid) {
        localStorage.setItem("hasPaid", isPaid ? "true" : "false");
        console.log("Maksutila tallennettu localStorageen:", isPaid);
      }

      // Hae maksutila localStoragesta
      function getPaymentStatus() {
        return localStorage.getItem("hasPaid") === "true";
      }

      // Tallenna maksun aikaleima
      function savePaymentTimestamp() {
        const expiryTime = Date.now() + 3 * 60 * 1000; // Nykyinen aika + 3 minuuttia
        localStorage.setItem("paymentExpiry", expiryTime.toString());
        console.log(
          "Maksun vanhenemisaika tallennettu:",
          new Date(expiryTime).toLocaleTimeString()
        );
      }

      // Tarkista onko maksu vanhentunut
      function isPaymentExpired() {
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) return false;

        const now = Date.now();
        const expired = now > parseInt(expiryTime);

        console.log(
          "Maksun vanhenemisaika:",
          new Date(parseInt(expiryTime)).toLocaleTimeString()
        );
        console.log("Nykyinen aika:", new Date(now).toLocaleTimeString());
        console.log("Maksu vanhentunut:", expired);

        return expired;
      }

      // Tallenna allekirjoitukset localStorageen
      function saveSignaturesToLocal(name, images, color) {
        const signatureData = {
          name,
          images,
          color,
          createdAt: new Date().toISOString(),
        };

        localStorage.setItem("signatures", JSON.stringify(signatureData));
        console.log("Allekirjoitukset tallennettu localStorageen");
      }

      // Hae allekirjoitukset localStoragesta
      function getSignaturesFromLocal() {
        const data = localStorage.getItem("signatures");
        return data ? JSON.parse(data) : null;
      }

      // Muokataan createSignatures-funktiota
      async function createSignatures() {
        const name = nameInput.value.trim();
        const color = document.querySelector(
          'input[name="color"]:checked'
        ).value;

        if (!name) {
          alert("Syötä nimesi ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, color }),
          });

          if (!response.ok) {
            throw new Error(
              `Virhe allekirjoituksen luonnissa: ${response.status}`
            );
          }

          const data = await response.json();

          // Tallenna allekirjoitukset localStorageen
          saveSignaturesToLocal(name, data.images, color);

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          data.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${name} allekirjoitus`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Näytä ostonappi
          buyButton.style.display = "inline-block";

          // Näytä viesti
          statusMessage.textContent = "Allekirjoitukset luotu onnistuneesti!";
          statusMessage.style.color = "#4CAF50"; // Vihreä väri

          // Tarkista tila
          checkStatus();
        } catch (error) {
          console.error("Virhe allekirjoitusten luonnissa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten luonnissa.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Tarkista tila
      async function checkStatus(autoDownload = true) {
        // Tarkista localStoragesta
        const signatures = getSignaturesFromLocal();
        const hasPaid = getPaymentStatus();

        console.log("Tarkistetaan tila localStoragesta:");
        console.log("- Allekirjoitukset:", !!signatures);
        console.log("- Maksettu:", hasPaid);

        const data = {
          hasSignatures: !!signatures,
          hasPaid: hasPaid,
          canDownload: !!signatures && hasPaid,
        };

        console.log("Tila päivitetty:", data);

        if (data.hasSignatures) {
          if (data.hasPaid && data.canDownload) {
            console.log("Maksu vahvistettu, allekirjoitukset ladattavissa");
            statusMessage.textContent =
              "Maksu onnistui! Allekirjoitukset ladattavissa.";
            statusMessage.style.color = "#4CAF50"; // Vihreä väri
            buyButton.style.display = "none";

            // Näytä "Lataa uudelleen" -nappi
            downloadAgainContainer.style.display = "block";

            // Näytä sähköpostikenttä
            emailContainer.style.display = "block";

            // Näytä reset-container ja käynnistä ajastin
            resetContainer.style.display = "block";

            // Käynnistä ajastin vain jos sitä ei ole jo käynnistetty
            if (!resetTimerInterval) {
              resetTimeLeft = 180; // 3 minuuttia
              updateResetTimer(); // Päivitä heti kerran
              resetTimerInterval = setInterval(updateResetTimer, 1000);
            }

            // Tarkista onko automaattinen lataus jo suoritettu
            const hasAutoDownloaded = localStorage.getItem("hasAutoDownloaded");

            if (autoDownload && !hasAutoDownloaded) {
              // Merkitse automaattinen lataus suoritetuksi
              localStorage.setItem("hasAutoDownloaded", "true");

              // Viive ennen latausta, jotta käyttäjä näkee viestin
              setTimeout(() => {
                downloadSignatures();
              }, 1000);
            }
          } else {
            // Näytä viesti vain jos käyttäjä on luonut allekirjoitukset
            if (signaturesContainer.innerHTML.trim() !== "") {
              statusMessage.textContent = "Allekirjoitukset luotu!";
              statusMessage.style.color = "#6e8efb"; // Sininen väri
              buyButton.style.display = "inline-block";

              // Piilota "Lataa uudelleen" -nappi ja reset-container
              downloadAgainContainer.style.display = "none";
              resetContainer.style.display = "none";

              // Pysäytä ajastin
              if (resetTimerInterval) {
                clearInterval(resetTimerInterval);
                resetTimerInterval = null;
              }
            }
          }
        } else {
          // Ei allekirjoituksia, piilota ostonappi
          buyButton.style.display = "none";
          statusMessage.textContent = "";

          // Piilota "Lataa uudelleen" -nappi ja reset-container
          downloadAgainContainer.style.display = "none";
          resetContainer.style.display = "none";

          // Pysäytä ajastin
          if (resetTimerInterval) {
            clearInterval(resetTimerInterval);
            resetTimerInterval = null;
          }
        }
      }

      // Muokataan downloadSignatures-funktiota
      async function downloadSignatures() {
        try {
          // Hae allekirjoitukset localStoragesta
          const signatures = getSignaturesFromLocal();

          if (!signatures || !signatures.images || !signatures.images.length) {
            throw new Error("Allekirjoituksia ei löytynyt localStoragesta");
          }

          console.log("Ladataan puhtaat allekirjoitukset...");

          // Hae puhtaat allekirjoitukset palvelimelta
          const response = await fetch(
            `${API_URL}/api/create-clean-signatures`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: signatures.name,
                color: signatures.color,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(
              `Virhe puhtaiden allekirjoitusten luonnissa: ${response.status}`
            );
          }

          const cleanData = await response.json();

          // Luo ZIP-tiedosto
          const zip = new JSZip();

          // Lisää puhtaat kuvat ZIP-tiedostoon
          cleanData.images.forEach((imageData, index) => {
            // Poista data:image/png;base64, -etuliite
            const base64Data = imageData.replace(
              /^data:image\/png;base64,/,
              ""
            );
            zip.file(`allekirjoitus_${index + 1}.png`, base64Data, {
              base64: true,
            });
          });

          // Generoi ZIP-tiedosto
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // Luo latauslinkki
          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(zipBlob);
          downloadLink.download = `allekirjoitukset_${signatures.name.replace(
            /\s+/g,
            "_"
          )}.zip`;

          // Simuloi klikkausta
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          console.log("Allekirjoitukset ladattu onnistuneesti");
          statusMessage.textContent = "Allekirjoitukset ladattu onnistuneesti!";
          statusMessage.style.color = "#4CAF50"; // Vihreä väri
        } catch (error) {
          console.error("Virhe allekirjoitusten latauksessa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten latauksessa.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Muokataan checkExistingSignatures-funktiota
      function checkExistingSignatures() {
        const signatures = getSignaturesFromLocal();

        if (signatures && signatures.images && signatures.images.length > 0) {
          console.log("Löydettiin aiemmat allekirjoitukset:", signatures);

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          signatures.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${signatures.name} allekirjoitus`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Täytä nimi-kenttä
          nameInput.value = signatures.name;

          // Tarkista tila uudelleen
          checkStatus();

          return true;
        }

        return false;
      }

      // Muokataan resetAllData-funktiota
      async function resetAllData() {
        // Tyhjennä localStorage
        localStorage.removeItem("clientIp");
        localStorage.removeItem("hasAutoDownloaded");
        localStorage.removeItem("hasPaid");
        localStorage.removeItem("signatures");
        localStorage.removeItem("paymentExpiry");

        // Tyhjennä allekirjoitukset
        signaturesContainer.innerHTML = "";

        // Tyhjennä nimi
        nameInput.value = "";

        // Piilota napit ja viestit
        buyButton.style.display = "none";
        downloadAgainContainer.style.display = "none";
        emailContainer.style.display = "none";
        resetContainer.style.display = "none";

        // Näytä viesti
        statusMessage.textContent = "Tiedot poistettu. Ohjataan etusivulle...";
        statusMessage.style.color = "#4CAF50"; // Vihreä väri

        // Pysäytä ajastin
        if (resetTimerInterval) {
          clearInterval(resetTimerInterval);
        }

        // Pieni viive ennen ohjausta etusivulle
        setTimeout(() => {
          // Ohjaa käyttäjä etusivulle ja pakota sivu latautumaan uudelleen
          window.location.href =
            window.location.origin + window.location.pathname + "?reset=true";
        }, 1500);
      }

      // Muokataan createCheckoutSession-funktiota
      async function createCheckoutSession() {
        const signatures = getSignaturesFromLocal();

        if (!signatures) {
          alert("Luo allekirjoitukset ensin!");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/api/create-checkout-session`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: signatures.name,
              }),
            }
          );

          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error("Checkout URL puuttuu vastauksesta");
          }
        } catch (error) {
          console.error("Virhe maksun käsittelyssä:", error);
          alert("Virhe maksun käsittelyssä.");
        }
      }

      // Lisää tapahtumankäsittelijä painikkeelle
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const clientIp = await getClientIp();

        if (!email) {
          alert("Syötä sähköpostiosoite ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, clientIp }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Allekirjoitukset lähetetty sähköpostiisi!");
          } else {
            alert("Virhe sähköpostin lähetyksessä.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Virhe sähköpostin lähetyksessä:", error);
          alert("Virhe sähköpostin lähetyksessä.");
        }
      });

      // Käynnistä fonttien lataus ja alustus
      async function initialize() {
        // Tallenna IP-osoite heti alussa
        await saveClientIp();

        // Ei tarvitse enää alustaa karusellia
        // await loadFontsAndInitialize();

        // Lataa fontit allekirjoitusten luontia varten
        await loadFonts();

        // Tarkista maksun tila ensin
        await checkPaymentStatus();

        // Tarkista tila vasta kun IP on tallennettu
        await checkStatus();
      }

      // Lataa fontit allekirjoitusten luontia varten
      async function loadFonts() {
        try {
          // Tyhjennä fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lisää oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });

            console.log("Oma fontti ladattu onnistuneesti!");
          } catch (fontError) {
            console.error("Virhe oman fontin latauksessa:", fontError);
            // Jos oman fontin lataus epäonnistuu, käytä järjestelmäfonttia
            signatureFonts.push({
              name: "Järjestelmäfontti",
              font: "60px Arial, sans-serif",
            });
          }

          console.log("Fontit ladattu onnistuneesti:", signatureFonts);

          // Tarkista onko käyttäjällä jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          console.error("Virhe fonttien latauksessa:", error);
          // Virhetilanteessa käytä järjestelmäfonttia
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "Järjestelmäfontti",
            font: "60px Arial, sans-serif",
          });
        }
      }

      // Käynnistä sovellus
      initialize();

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Tarkista maksun tila sivun latautuessa
      async function checkPaymentStatus() {
        // Tarkista onko maksu vanhentunut
        if (isPaymentExpired()) {
          console.log("⏰ Maksu vanhentunut, tyhjennetään tiedot...");
          await resetAllData();
          return;
        }

        if (getQueryParam("success") === "true") {
          console.log("✅ Maksu onnistui, merkitään maksetuksi...");

          // Merkitse maksu onnistuneeksi heti localStorageen
          savePaymentStatus(true);
          console.log("Maksutila tallennettu localStorageen: true");

          // Tallenna maksun aikaleima
          savePaymentTimestamp();

          // Nollaa automaattisen latauksen tila, jos käyttäjä on juuri maksanut
          localStorage.removeItem("hasAutoDownloaded");

          // Tarkista tila heti
          checkStatus(true);
        } else if (getQueryParam("canceled") === "true") {
          console.log("❌ Maksu peruutettu.");
          statusMessage.textContent = "Maksu peruutettiin.";
        }
      }

      // Lisää tapahtumankäsittelijä "Lataa uudelleen" -napille
      downloadAgainButton.addEventListener("click", async () => {
        await downloadSignatures();
      });

      // Tarkista tila säännöllisesti, mutta varmista että IP on haettu
      setTimeout(() => {
        setInterval(checkStatus, 2000);
        checkStatus();
      }, 1000);

      // Ajastimen muuttujat
      let resetTimerInterval;
      let resetTimeLeft = 180; // 3 minuuttia sekunteina

      // Funktio ajastimen päivittämiseen
      function updateResetTimer() {
        // Hae jäljellä oleva aika localStoragesta
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) {
          resetTimer.textContent =
            "Tiedot poistetaan automaattisesti 3:00 minuutin kuluttua";
          return;
        }

        const now = Date.now();
        const timeLeft = Math.max(0, parseInt(expiryTime) - now);

        // Muunna millisekunnit minuuteiksi ja sekunneiksi
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);

        resetTimer.textContent = `Tiedot poistetaan automaattisesti ${minutes}:${
          seconds < 10 ? "0" : ""
        }${seconds} minuutin kuluttua`;

        if (timeLeft <= 0) {
          clearInterval(resetTimerInterval);
          resetAllData();
        }
      }

      // Lisää tapahtumankäsittelijä "Luo lisää allekirjoituksia" -napille
      resetButton.addEventListener("click", resetAllData);

      // Tarkista onko sivu ladattu resetoinnin jälkeen
      if (getQueryParam("reset") === "true") {
        console.log("Sivu ladattu resetoinnin jälkeen");
        // Poista reset-parametri URL:sta ilman sivun uudelleenlatausta
        const url = new URL(window.location);
        url.searchParams.delete("reset");
        window.history.replaceState({}, document.title, url);
      }

      // Lisää tapahtumankäsittelijä ostonapille
      buyButton.addEventListener("click", async () => {
        await createCheckoutSession();
      });
    </script>
  </body>
</html>
