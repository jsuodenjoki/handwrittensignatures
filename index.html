<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Allekirjoitusgeneraattori</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto 40px auto;
        overflow: hidden;
        position: relative;
      }

      .signature-carousel {
        display: flex;
        transition: transform 0.5s ease;
        gap: 30px;
        padding: 10px 100px;
      }

      .carousel-item {
        min-width: 250px;
        height: 150px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .carousel-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      @media (max-width: 1200px) {
        .carousel-item {
          min-width: calc(33.333% - 20px);
        }
      }

      @media (max-width: 900px) {
        .signature-carousel-container {
          margin-bottom: 30px;
        }

        .carousel-item {
          min-width: calc(50% - 20px);
          height: 120px;
        }
      }

      @media (max-width: 600px) {
        .carousel-item {
          min-width: calc(100% - 40px);
        }
      }

      /* Lisää oma fontti @font-face-säännöllä */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Allekirjoitusgeneraattori</h1>
    <p>Luo kauniita käsinkirjoitettuja allekirjoituksia helposti</p>

    <!-- Lisätään allekirjoituskaruselli -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <!-- Karusellin sisältö täytetään JavaScriptillä -->
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Kirjoita nimesi tähän..."
          style="width: 40%"
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Luo allekirjoitukset
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Osta allekirjoitukset (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Haluatko allekirjoitukset myös sähköpostiisi?</h2>
      <input type="email" id="emailInput" placeholder="Sähköpostiosoitteesi" />
      <button id="sendEmailButton">Lähetä allekirjoitukset sähköpostiin</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");

      // Fontit allekirjoituksille - alusta tyhjä lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Anna Virtanen",
        "Matti Korhonen",
        "Liisa Mäkinen",
        "Juha Nieminen",
        "Sari Laine",
        "Mikko Koskinen",
        "Tiina Järvinen",
      ];

      // Luo allekirjoitukset karuselliin
      async function initializeCarousel() {
        // Tyhjennä karuselli
        signatureCarousel.innerHTML = "";

        // Odota että fontit on ladattu
        await document.fonts.ready;

        console.log("Alustetaan karuselli käyttäen backend-reittiä");

        // Luo esimerkkiallekirjoitukset ja lisää ne karuselliin
        const signatures = [];

        // Luo esimerkkiallekirjoitukset backendissä
        try {
          // Luo allekirjoitukset jokaiselle esimerkkihenkilölle
          for (const name of exampleNames) {
            try {
              // Käytä samaa backend-reittiä kuin käyttäjän allekirjoituksille
              const response = await fetch(
                `${API_URL}/api/create-signature-for-carousel`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ name }),
                }
              );

              if (!response.ok) {
                throw new Error(
                  `Virhe allekirjoituksen luonnissa: ${response.status}`
                );
              }

              const data = await response.json();

              if (data.image) {
                signatures.push({
                  name,
                  image: data.image,
                  font: "Oma Fontti",
                });
              }
            } catch (error) {
              console.error(
                `Virhe esimerkkiallekirjoituksen luonnissa (${name}):`,
                error
              );
            }
          }

          // Jos ei saatu yhtään allekirjoitusta, näytä virheilmoitus
          if (signatures.length === 0) {
            const message = document.createElement("div");
            message.className = "carousel-item";
            message.textContent =
              "Esimerkkiallekirjoitusten luonti epäonnistui.";
            signatureCarousel.appendChild(message);
            return;
          }

          console.log(`Luotu ${signatures.length} esimerkkiallekirjoitusta`);

          // Lisää allekirjoitukset karuselliin
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Lisää samat allekirjoitukset uudelleen, jotta karuselli näyttää jatkuvalta
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Käynnistä karusellin animaatio
          startCarouselAnimation();
        } catch (error) {
          console.error("Virhe karusellin alustuksessa:", error);
          const message = document.createElement("div");
          message.className = "carousel-item";
          message.textContent = "Virhe esimerkkiallekirjoitusten luonnissa.";
          signatureCarousel.appendChild(message);
        }
      }

      // Karusellin animaatio
      let carouselPosition = 0;
      let carouselAnimationId;
      let isResetting = false;

      function startCarouselAnimation() {
        if (carouselAnimationId) {
          cancelAnimationFrame(carouselAnimationId);
        }

        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const totalItems = items.length;
        const visibleItems = 3; // Näkyvien elementtien määrä
        const itemWidth = 280; // Elementin leveys + marginaali
        const duration = 10000; // Koko kierroksen kesto millisekunteina
        const step = ((itemWidth * exampleNames.length) / duration) * 16.7; // Siirtymä per frame
        const containerWidth = document.querySelector(
          ".signature-carousel-container"
        ).offsetWidth;

        // Aseta alkuposition niin, että ensimmäinen elementti on näkyvissä
        carouselPosition = 0;

        function animateCarousel() {
          if (!isResetting) {
            carouselPosition -= step;

            // Kun karuselli on liikkunut tarpeeksi, valmistele paluu alkuun
            // Tarkistetaan onko ensimmäinen "aito" elementti liikkunut pois näkyvistä
            if (carouselPosition <= -itemWidth * exampleNames.length) {
              isResetting = true;

              // Poista transition väliaikaisesti
              signatureCarousel.style.transition = "none";

              // Aseta timeout, jotta transition-muutos ehtii vaikuttaa
              setTimeout(() => {
                // Nollaa positio
                carouselPosition = 0;
                signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

                // Palauta transition pienen viiveen jälkeen
                setTimeout(() => {
                  signatureCarousel.style.transition = "transform 0.5s ease";
                  isResetting = false;
                }, 20);
              }, 20);
            }
          }

          // Päivitä karusellin sijainti
          if (!isResetting) {
            signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

            // Päivitä elementtien läpinäkyvyys sijainnin perusteella
            updateItemsOpacity(containerWidth);
          }

          carouselAnimationId = requestAnimationFrame(animateCarousel);
        }

        carouselAnimationId = requestAnimationFrame(animateCarousel);
      }

      // Päivitä elementtien läpinäkyvyys
      function updateItemsOpacity(containerWidth) {
        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const fadeZone = 200; // Häivytysvyöhykkeen leveys

        items.forEach((item) => {
          const rect = item.getBoundingClientRect();
          const containerRect =
            signatureCarousel.parentElement.getBoundingClientRect();

          // Laske etäisyys vasemmasta ja oikeasta reunasta
          const distanceFromLeft = rect.left - containerRect.left;
          const distanceFromRight = containerRect.right - rect.right;

          // Laske läpinäkyvyys etäisyyden perusteella
          let opacity = 1;
          let scale = 1;

          if (distanceFromLeft < fadeZone) {
            opacity = distanceFromLeft / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          } else if (distanceFromRight < fadeZone) {
            opacity = distanceFromRight / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          }

          // Rajoita läpinäkyvyys välille 0-1 ja aseta se
          opacity = Math.max(0.1, Math.min(1, opacity));
          item.style.opacity = opacity;
          item.style.transform = `scale(${scale})`;
        });
      }

      // Luo allekirjoitukset
      async function createSignatures() {
        const name = nameInput.value.trim();
        const color = document.querySelector(
          'input[name="color"]:checked'
        ).value;

        if (!name) {
          alert("Syötä nimesi ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, color }),
          });

          if (!response.ok) {
            throw new Error(
              `Virhe allekirjoituksen luonnissa: ${response.status}`
            );
          }

          const data = await response.json();

          // Tallenna allekirjoitukset myös selaimen paikalliseen tallennustilaan
          localStorage.setItem(
            "signatures",
            JSON.stringify({
              name,
              images: data.images,
              createdAt: new Date().toISOString(),
            })
          );

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          data.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${name} allekirjoitus`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Näytä ostonappi
          buyButton.style.display = "inline-block";

          // Näytä viesti
          statusMessage.textContent = "Allekirjoitukset luotu onnistuneesti!";
          statusMessage.style.color = "#4CAF50"; // Vihreä väri
        } catch (error) {
          console.error("Virhe allekirjoitusten luonnissa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten luonnissa.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Tarkista onko käyttäjällä jo allekirjoituksia
      function checkExistingSignatures() {
        // Tarkista ensin paikallisesta tallennustilasta
        const localSignatures = localStorage.getItem("signatures");

        if (localSignatures) {
          try {
            const data = JSON.parse(localSignatures);

            // Näytä tallennetut allekirjoitukset
            signaturesContainer.innerHTML = "";
            data.images.forEach((imageData) => {
              const signatureItem = document.createElement("div");
              signatureItem.className = "signature-item";

              const img = document.createElement("img");
              img.src = imageData;
              img.alt = `${data.name} allekirjoitus`;

              signatureItem.appendChild(img);
              signaturesContainer.appendChild(signatureItem);
            });

            // Aseta nimi kenttään, mutta vain jos kenttä on tyhjä
            if (nameInput.value.trim() === "" && data.name) {
              nameInput.value = data.name;
            }

            // Näytä selkeä viesti käyttäjälle
            statusMessage.textContent = `Aiemmin luodut allekirjoitukset (${data.name}) ladattu.`;
            statusMessage.style.color = "#4CAF50"; // Vihreä väri

            // Näytä ostonappi
            buyButton.style.display = "inline-block";

            // Lähetä allekirjoitukset takaisin palvelimelle
            sendSignaturesToServer(data);

            return;
          } catch (error) {
            console.error(
              "Virhe paikallisten allekirjoitusten lataamisessa:",
              error
            );
          }
        }

        // Jos paikallisesta tallennustilasta ei löydy, tarkista palvelimelta
        fetch(`${API_URL}/api/get-signatures`)
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Ei allekirjoituksia");
          })
          .then((data) => {
            // Tarkista, että data on oikeassa muodossa ja sisältää kuvia
            if (
              data &&
              data.images &&
              Array.isArray(data.images) &&
              data.images.length > 0 &&
              data.name // Varmista että nimikentässä on arvo
            ) {
              console.log("Löydettiin aiemmat allekirjoitukset:", data);

              // Tallenna allekirjoitukset myös selaimen paikalliseen tallennustilaan
              localStorage.setItem("signatures", JSON.stringify(data));

              // Näytä tallennetut allekirjoitukset
              signaturesContainer.innerHTML = "";
              data.images.forEach((imageData) => {
                const signatureItem = document.createElement("div");
                signatureItem.className = "signature-item";

                const img = document.createElement("img");
                img.src = imageData;
                img.alt = `${data.name} allekirjoitus`;

                signatureItem.appendChild(img);
                signaturesContainer.appendChild(signatureItem);
              });

              // Aseta nimi kenttään, mutta vain jos kenttä on tyhjä
              if (nameInput.value.trim() === "" && data.name) {
                nameInput.value = data.name;
              }

              // Näytä selkeä viesti käyttäjälle
              statusMessage.textContent = `Aiemmin luodut allekirjoitukset (${data.name}) ladattu.`;
              statusMessage.style.color = "#4CAF50"; // Vihreä väri

              // Näytä ostonappi
              buyButton.style.display = "inline-block";
            } else {
              console.log(
                "Ei aiempia allekirjoituksia tai data on virheellinen:",
                data
              );
              // Tyhjennä allekirjoituskontti
              signaturesContainer.innerHTML = "";
              // Piilota ostonappi
              buyButton.style.display = "none";
              // Tyhjennä statusviesti
              statusMessage.textContent = "";
            }
          })
          .catch((error) => {
            console.log("Ei aiempia allekirjoituksia:", error);
            // Tyhjennä allekirjoituskontti
            signaturesContainer.innerHTML = "";
            // Piilota ostonappi
            buyButton.style.display = "none";
            // Tyhjennä statusviesti
            statusMessage.textContent = "";
          });
      }

      // Funktio allekirjoitusten lähettämiseksi takaisin palvelimelle
      async function sendSignaturesToServer(data) {
        try {
          const response = await fetch(`${API_URL}/api/restore-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: data.name,
              images: data.images,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          console.log("Allekirjoitukset palautettu palvelimelle onnistuneesti");

          // Tarkista tila uudelleen
          checkStatus();
        } catch (error) {
          console.error(
            "Virhe allekirjoitusten palauttamisessa palvelimelle:",
            error
          );
        }
      }

      // Luo allekirjoitukset
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Tarkista allekirjoitusten tila
      function checkStatus(autoDownload = false) {
        fetch(`${API_URL}/api/check-signatures`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Tila päivitetty:", data);
            if (data.hasSignatures) {
              if (data.hasPaid && data.canDownload) {
                console.log("Maksu vahvistettu, ladataan allekirjoitukset...");
                if (autoDownload) {
                  downloadSignatures();
                  emailContainer.style.display = "block";
                } else {
                  statusMessage.textContent =
                    "Maksu onnistui! Voit ladata allekirjoitukset.";
                  statusMessage.style.color = "#4CAF50"; // Vihreä väri
                  buyButton.style.display = "none";

                  // Näytä latauslinkki
                  const downloadButton = document.createElement("button");
                  downloadButton.className = "buy-button";
                  downloadButton.style.display = "block";
                  downloadButton.textContent = "Lataa allekirjoitukset";
                  downloadButton.onclick = () => downloadSignatures();

                  // Tyhjennä mahdolliset vanhat linkit
                  const downloadContainer =
                    document.getElementById("downloadLinks") ||
                    document.createElement("div");
                  downloadContainer.id = "downloadLinks";
                  downloadContainer.innerHTML = "";
                  downloadContainer.appendChild(downloadButton);

                  // Lisää latauslinkki sivulle
                  if (!document.getElementById("downloadLinks")) {
                    document.body.appendChild(downloadContainer);
                  }
                }
              } else {
                statusMessage.textContent = "Allekirjoitukset luotu!";
                buyButton.style.display = "block";
              }
            }
          })
          .catch((error) => {
            console.error("Virhe tilan tarkistuksessa:", error);
            statusMessage.textContent = "Virhe tilan tarkistuksessa.";
          });
      }

      // Lataa allekirjoitukset
      function downloadSignatures() {
        window.location.href = `${API_URL}/api/download-signatures`;
      }

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();

        if (!email) {
          alert("Syötä sähköpostiosoite ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Allekirjoitukset lähetetty sähköpostiisi!");
          } else {
            alert("Virhe sähköpostin lähetyksessä.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Virhe sähköpostin lähetyksessä:", error);
          alert("Virhe sähköpostin lähetyksessä.");
        }
      });

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Alusta käyttöliittymä
      window.addEventListener("load", () => {
        // Piilota osta-painike aluksi
        buyButton.style.display = "none";

        // Tyhjennä statusviesti
        statusMessage.textContent = "";

        // Tyhjennä allekirjoituskontti
        signaturesContainer.innerHTML = "";

        // Tyhjennä nimikenttä
        nameInput.value = "";

        if (getQueryParam("success") === "true") {
          console.log("✅ Maksu onnistui, tarkistetaan tila...");
          checkStatus(true);
        } else if (getQueryParam("canceled") === "true") {
          console.log("❌ Maksu peruutettu.");
          statusMessage.textContent = "Maksu peruutettiin.";
          statusMessage.style.color = "#f44336";
        }

        // Alusta karuselli
        initializeCarousel();
      });

      // Tarkista tila säännöllisesti
      setInterval(checkStatus, 2000);

      // Lataa oma fontti dynaamisesti ja alusta karuselli vasta kun fontti on ladattu
      async function loadFontsAndInitialize() {
        try {
          // Tyhjennä fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lisää oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });

            console.log("Oma fontti ladattu onnistuneesti!");
          } catch (fontError) {
            console.error("Virhe oman fontin latauksessa:", fontError);
            // Jos oman fontin lataus epäonnistuu, käytä järjestelmäfonttia
            signatureFonts.push({
              name: "Järjestelmäfontti",
              font: "60px Arial, sans-serif",
            });
          }

          console.log("Fontit ladattu onnistuneesti:", signatureFonts);

          // Alusta karuselli vasta kun fontit on ladattu
          await initializeCarousel();

          // Tarkista onko käyttäjällä jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          console.error("Virhe fonttien latauksessa:", error);
          // Virhetilanteessa alusta karuselli järjestelmäfontilla
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "Järjestelmäfontti",
            font: "60px Arial, sans-serif",
          });
          initializeCarousel();
        }
      }

      // Käynnistä fonttien lataus ja alustus
      loadFontsAndInitialize();

      // Tarkista fonttitiedostojen saatavuus
      async function checkFontAvailability() {
        const fontPaths = [
          "./fonts/omafontti1.ttf",
          "/fonts/omafontti1.ttf",
          "../public/fonts/omafontti1.ttf",
        ];

        for (const path of fontPaths) {
          try {
            const response = await fetch(path, { method: "HEAD" });
            console.log(
              `Fonttitiedoston tarkistus (${path}): ${response.status}`
            );
          } catch (error) {
            console.error(
              `Virhe fonttitiedoston tarkistuksessa (${path}):`,
              error
            );
          }
        }
      }

      // Suorita tarkistus
      checkFontAvailability();

      async function regenerateSignaturesWithoutBlur() {
        const response = await fetch(`${API_URL}/api/get-signatures`);
        const data = await response.json();

        // Luo kuvat uudelleen ilman blur-efektiä
        data.images.forEach((imageData, index) => {
          const img = new Image();
          img.src = imageData;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const newImageData = canvas.toDataURL("image/png");

            // Päivitä kuva ilman blur-efektiä
            const imgElement = document.querySelectorAll(".signature-item img")[
              index
            ];
            imgElement.src = newImageData;
          };
        });
      }

      // Funktio allekirjoitusten tilan tarkistamiseen
      async function checkSignatureStatus() {
        const response = await fetch("/api/check-signatures");
        const status = await response.json();
        console.log("Tila päivitetty:", status);
        return status;
      }
    </script>
  </body>
</html>
