<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Allekirjoitusgeneraattori</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Allekirjoitusgeneraattori</h1>
    <p>Luo kauniita käsinkirjoitettuja allekirjoituksia helposti</p>

    <div class="container">
      <div class="input-group">
        <label for="nameInput">Syötä nimesi:</label>
        <input
          type="text"
          id="nameInput"
          placeholder="Kirjoita nimesi tähän..."
        />
      </div>

      <button id="generateSignatures" class="button primary-button">
        Luo allekirjoitukset
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Osta allekirjoitukset (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Haluatko allekirjoitukset myös sähköpostiisi?</h2>
      <input type="email" id="emailInput" placeholder="Sähköpostiosoitteesi" />
      <button id="sendEmailButton">Lähetä allekirjoitukset sähköpostiin</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : "https://handwrittensignatures.vercel.app/";

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");

      // Fontit allekirjoituksille
      const signatureFonts = [
        { name: "Cursive", font: "40px 'Dancing Script', cursive" },
        { name: "Elegant", font: "40px 'Parisienne', cursive" },
        { name: "Modern", font: "40px 'Caveat', cursive" },
        { name: "Classic", font: "40px 'Great Vibes', cursive" },
      ];

      // Lataa fontit
      const fontStylesheet = document.createElement("link");
      fontStylesheet.rel = "stylesheet";
      fontStylesheet.href =
        "https://fonts.googleapis.com/css2?family=Dancing+Script&family=Parisienne&family=Caveat&family=Great+Vibes&display=swap";
      document.head.appendChild(fontStylesheet);

      // Luo allekirjoitukset
      generateSignaturesButton.addEventListener("click", async () => {
        const name = nameInput.value.trim();

        if (!name) {
          statusMessage.textContent = "Syötä nimesi ensin!";
          return;
        }

        statusMessage.textContent = "Luodaan allekirjoituksia...";
        signaturesContainer.innerHTML = "";

        const signatureImages = [];

        // Luo allekirjoitus jokaisella fontilla
        for (const fontStyle of signatureFonts) {
          const canvas = document.createElement("canvas");
          canvas.width = 600;
          canvas.height = 200;

          const ctx = canvas.getContext("2d");
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.fillStyle = "black";
          ctx.font = fontStyle.font;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(name, canvas.width / 2, canvas.height / 2);

          const imageData = canvas.toDataURL("image/png");
          signatureImages.push(imageData);

          // Näytä allekirjoitus käyttöliittymässä
          const signatureItem = document.createElement("div");
          signatureItem.className = "signature-item";

          const img = document.createElement("img");
          img.src = imageData;
          img.alt = `${name} - ${fontStyle.name}`;

          signatureItem.appendChild(img);
          signaturesContainer.appendChild(signatureItem);
        }

        // Tallenna allekirjoitukset palvelimelle
        try {
          const response = await fetch(`${API_URL}/api/generate-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name,
              signatureImages,
            }),
          });

          const data = await response.json();

          if (data.success) {
            statusMessage.textContent = "Allekirjoitukset luotu onnistuneesti!";
            buyButton.style.display = "inline-block";
          } else {
            statusMessage.textContent = "Virhe allekirjoitusten luonnissa.";
          }
        } catch (error) {
          console.error("Virhe allekirjoitusten tallennuksessa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten tallennuksessa.";
        }
      });

      // Tarkista allekirjoitusten tila
      function checkStatus(autoDownload = false) {
        fetch(`${API_URL}/api/check-signatures`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Tila päivitetty:", data);

            if (data.hasSignatures) {
              if (data.hasPaid && data.canDownload) {
                console.log("Maksu vahvistettu, ladataan allekirjoitukset...");
                statusMessage.textContent =
                  "Maksu onnistui! Allekirjoitukset ladataan...";
                buyButton.style.display = "none";

                if (autoDownload) {
                  downloadSignatures();
                  emailContainer.style.display = "block";
                }
              } else {
                statusMessage.textContent = "Allekirjoitukset luotu!";
                buyButton.style.display = "inline-block";
              }
            }
          })
          .catch((error) => {
            console.error("Virhe tilan tarkistuksessa:", error);
          });
      }

      // Lataa allekirjoitukset
      function downloadSignatures() {
        window.location.href = `${API_URL}/api/download-signatures`;
      }

      // Osta-painikkeen toiminnallisuus
      buyButton.addEventListener("click", async () => {
        try {
          const response = await fetch(`${API_URL}/api/create-payment`, {
            method: "POST",
          });
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          console.error("Virhe maksun luonnissa:", error);
          statusMessage.textContent = "Virhe maksun käsittelyssä.";
        }
      });

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();

        if (!email) {
          alert("Syötä sähköpostiosoite ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Allekirjoitukset lähetetty sähköpostiisi!");
          } else {
            alert("Virhe sähköpostin lähetyksessä.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Virhe sähköpostin lähetyksessä:", error);
          alert("Virhe sähköpostin lähetyksessä.");
        }
      });

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Sivun latautuessa
      window.addEventListener("load", () => {
        if (getQueryParam("success") === "true") {
          console.log("✅ Maksu onnistui, tarkistetaan tila...");
          checkStatus(true);
        } else if (getQueryParam("canceled") === "true") {
          console.log("❌ Maksu peruutettu.");
          statusMessage.textContent = "Maksu peruutettiin.";
        }

        // Tarkista onko käyttäjällä jo allekirjoituksia
        fetch(`${API_URL}/api/get-signatures`)
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Ei allekirjoituksia");
          })
          .then((data) => {
            if (data.images && data.images.length > 0) {
              nameInput.value = data.name || "";

              // Näytä tallennetut allekirjoitukset
              signaturesContainer.innerHTML = "";
              data.images.forEach((imageData) => {
                const signatureItem = document.createElement("div");
                signatureItem.className = "signature-item";

                const img = document.createElement("img");
                img.src = imageData;
                img.alt = "Tallennettu allekirjoitus";

                signatureItem.appendChild(img);
                signaturesContainer.appendChild(signatureItem);
              });

              statusMessage.textContent =
                "Aiemmin luodut allekirjoitukset ladattu.";
              buyButton.style.display = "inline-block";
            }
          })
          .catch((error) => {
            console.log("Ei aiempia allekirjoituksia:", error);
          });
      });

      // Tarkista tila säännöllisesti
      setInterval(checkStatus, 2000);
    </script>
  </body>
</html>
