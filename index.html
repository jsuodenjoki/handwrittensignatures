<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Handwritten Signature Generator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        padding-bottom: 0px !important;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        width: 100%;
      }

      input[type="text"] {
        width: 60%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
        margin-bottom: 30px !important;
        margin-top: 30px !important;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }

        input[type="text"] {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto 40px auto;
        overflow: hidden;
        position: relative;
      }

      .signature-carousel {
        display: flex;
        transition: transform 0.5s ease;
        gap: 30px;
        padding: 10px 100px;
      }

      .carousel-item {
        min-width: 250px;
        height: 150px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        will-change: transform, opacity;
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      .carousel-item img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        display: block;
        will-change: transform;
        transform: translateZ(0);
      }

      @media (max-width: 1200px) {
        .carousel-item {
          min-width: calc(33.333% - 20px);
        }
      }

      @media (max-width: 900px) {
        .signature-carousel-container {
          margin-bottom: 30px;
        }

        .signature-carousel {
          padding: 10px 20px;
          gap: 15px;
          scroll-snap-type: x mandatory;
        }

        .carousel-item {
          min-width: 180px;
          height: 120px;
          scroll-snap-align: center;
          background-color: rgba(255, 255, 255, 0.2);
        }

        .carousel-item.active {
          opacity: 1 !important;
          transform: scale(1.05) !important;
        }
      }

      @media (max-width: 600px) {
        .signature-carousel {
          padding: 10px 10px;
        }

        .carousel-item {
          min-width: 160px;
          height: 100px;
        }
      }

      /* Lisää oma fontti @font-face-säännöllä */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }

      /* Allekirjoituskontti */
      .signaturesContainer {
        background-color: #f5f5f5;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        max-width: 100%;
        overflow: hidden;
      }

      /* Allekirjoitus */
      .signature {
        background-color: white;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        overflow: hidden;
      }

      /* Varmista että kuvat eivät koskaan mene yli ruudun */
      .signature img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Handwritten Signature Generator</h1>
    <p>Generate beautiful handwritten signatures easily</p>

    <!-- Lisätään allekirjoituskaruselli -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <!-- Karusellin sisältö täytetään JavaScriptillä -->
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Write your name here..."
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Create signatures
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Buy signatures (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Do you want to receive the signatures to your email?</h2>
      <input type="email" id="emailInput" placeholder="Your email address" />
      <button id="sendEmailButton">Send signatures to email</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <div
      id="download-again-container"
      class="email-container"
      style="display: none"
    >
      <button id="downloadAgainButton" class="button primary-button">
        Download signatures again
      </button>
    </div>

    <div id="reset-container" class="email-container" style="display: none">
      <div id="reset-timer" class="status-message">
        Data will be automatically deleted in 3:00 minutes
      </div>
      <button id="resetButton" class="button primary-button">
        Create more signatures
      </button>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");
      const downloadAgainContainer = document.getElementById(
        "download-again-container"
      );
      const downloadAgainButton = document.getElementById(
        "downloadAgainButton"
      );
      const resetContainer = document.getElementById("reset-container");
      const resetButton = document.getElementById("resetButton");
      const resetTimer = document.getElementById("reset-timer");

      // Fontit allekirjoituksille - alusta tyhjä lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Emma Johnson",
        "James Smith",
        "Olivia Williams",
        "Liam Brown",
        "Sophia Davis",
        "Benjamin Wilson",
        "Charlotte Miller",
        "Ethan Moore",
        "Isabella Taylor",
        "Mason Anderson",
        "Mia Thomas",
        "Alexander Harris",
        "Amelia Martin",
        "Daniel Thompson",
        "Harper White",
        "Henry Clark",
        "Evelyn Rodriguez",
        "Michael Lewis",
        "Abigail Walker",
        "Lucas Hall",
        "Emily Allen",
        "William Young",
        "Scarlett King",
        "Elijah Scott",
        "Grace Wright",
        "Oliver Green",
      ];

      // Tallenna session ID localStorageen
      async function saveSessionId() {
        try {
          // Tarkista onko sessionId jo olemassa
          let sessionId = localStorage.getItem("sessionId");

          // Jos ei ole, hae uusi
          if (!sessionId) {
            const response = await fetch(`${API_URL}/api/get-session-id`);
            sessionId = await response.text();
            localStorage.setItem("sessionId", sessionId);
          }

          return sessionId;
        } catch (error) {
          return null;
        }
      }

      // Tallenna maksutila localStorageen
      function savePaymentStatus(isPaid) {
        localStorage.setItem("hasPaid", isPaid ? "true" : "false");
      }

      // Tallenna maksun aikaleima
      function savePaymentTimestamp() {
        const expiryTime = Date.now() + 3 * 60 * 1000; // Nykyinen aika + 3 minuuttia
        localStorage.setItem("paymentExpiry", expiryTime.toString());
      }

      // Hae tallennettu session ID tai hae uusi
      async function getSessionId() {
        let sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
          sessionId = await saveSessionId();
        }
        return sessionId;
      }

      // Hae maksutila localStoragesta
      function getPaymentStatus() {
        return localStorage.getItem("hasPaid") === "true";
      }

      // Tarkista onko maksu vanhentunut
      function isPaymentExpired() {
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) return false;

        const now = Date.now();
        const expired = now > parseInt(expiryTime);

        return expired;
      }

      // Luo allekirjoitukset karuselliin
      async function initializeCarousel() {
        try {
          // Tyhjennä karuselli
          signatureCarousel.innerHTML = "";

          // Luo esimerkkiallekirjoitukset karuselliin
          exampleNames.forEach((name) => {
            // Valitse satunnainen fontti
            const randomFont =
              signatureFonts[Math.floor(Math.random() * signatureFonts.length)];

            // Luo canvas
            const canvas = document.createElement("canvas");
            canvas.width = 250;
            canvas.height = 100;
            const ctx = canvas.getContext("2d");

            // Aseta valkoinen tausta
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Aseta fontti
            ctx.font = randomFont.font;
            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // Piirrä teksti
            ctx.fillText(name, canvas.width / 2, canvas.height / 2);

            // Luo karusellielementti
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";

            // Luo kuva
            const img = document.createElement("img");
            img.src = canvas.toDataURL("image/png");
            img.alt = name;

            // Lisää kuva karusellielementtiin
            carouselItem.appendChild(img);

            // Lisää karusellielementti karuselliin
            signatureCarousel.appendChild(carouselItem);
          });

          // Käynnistä karuselli
          startCarousel();
        } catch (error) {
          console.error("Error initializing carousel:", error);
        }
      }

      // Karusellin animaatio
      let carouselPosition = 0;
      let carouselAnimationId;
      let isResetting = false;

      function startCarouselAnimation() {
        if (carouselAnimationId) {
          cancelAnimationFrame(carouselAnimationId);
        }

        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const totalItems = items.length;
        const visibleItems = 3; // Näkyvien elementtien määrä
        const itemWidth = 280; // Elementin leveys + marginaali
        const duration = 60000; // Koko kierroksen kesto millisekunteina
        const step = ((itemWidth * exampleNames.length) / duration) * 16.7; // Siirtymä per frame
        const containerWidth = document.querySelector(
          ".signature-carousel-container"
        ).offsetWidth;

        // Aseta alkuposition niin, että ensimmäinen elementti on näkyvissä
        carouselPosition = 0;

        function animateCarousel() {
          if (!isResetting) {
            carouselPosition -= step;

            // Kun karuselli on liikkunut tarpeeksi, valmistele paluu alkuun
            if (carouselPosition <= -itemWidth * exampleNames.length) {
              isResetting = true;

              // Poista transition väliaikaisesti
              signatureCarousel.style.transition = "none";

              // Aseta timeout, jotta transition-muutos ehtii vaikuttaa
              setTimeout(() => {
                // Nollaa positio
                carouselPosition = 0;
                signatureCarousel.style.transform = `translate3d(${carouselPosition}px, 0, 0)`;

                // Palauta transition pienen viiveen jälkeen
                setTimeout(() => {
                  signatureCarousel.style.transition = "transform 0.5s ease";
                  isResetting = false;
                }, 20);
              }, 20);
            }
          }

          // Päivitä karusellin sijainti
          if (!isResetting) {
            signatureCarousel.style.transform = `translate3d(${carouselPosition}px, 0, 0)`;

            // Päivitä elementtien läpinäkyvyys sijainnin perusteella
            updateItemsOpacity(containerWidth);
          }

          carouselAnimationId = requestAnimationFrame(animateCarousel);
        }

        carouselAnimationId = requestAnimationFrame(animateCarousel);
      }

      // Optimoi updateItemsOpacity-funktiota
      function updateItemsOpacity(containerWidth) {
        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const fadeZone = 150;
        const isMobile = window.innerWidth <= 900;

        // Käytä requestAnimationFrame optimoimaan animaatiot
        requestAnimationFrame(() => {
          // Poista active-luokka kaikilta
          items.forEach((item) => item.classList.remove("active"));

          items.forEach((item) => {
            const rect = item.getBoundingClientRect();
            const containerRect =
              signatureCarousel.parentElement.getBoundingClientRect();

            // Laske keskikohta
            const itemCenter = rect.left + rect.width / 2;
            const containerCenter =
              containerRect.left + containerRect.width / 2;
            const distanceFromCenter = Math.abs(itemCenter - containerCenter);

            // Oletusarvot
            let opacity = 1;
            let scale = 1;

            // Jos mobiili, käytä yksinkertaisempaa logiikkaa
            if (isMobile) {
              // Vähennä animaatioiden määrää mobiilissa
              // Käytä vain kolmea tilaa: aktiivinen, lähellä, kaukana
              if (distanceFromCenter < rect.width / 2) {
                // Keskellä oleva elementti
                item.classList.add("active");
                opacity = 1;
                scale = 1.05;
              } else if (distanceFromCenter < rect.width * 1.5) {
                // Lähellä keskustaa olevat elementit
                opacity = 0.6;
                scale = 0.95;
              } else {
                // Kaukana olevat elementit
                opacity = 0.3;
                scale = 0.9;
              }
            } else {
              // Työpöytäversio
              const distanceFromLeft = rect.left - containerRect.left;
              const distanceFromRight = containerRect.right - rect.right;

              if (distanceFromLeft < fadeZone) {
                opacity = distanceFromLeft / fadeZone;
                scale = 0.9 + 0.1 * opacity;
              } else if (distanceFromRight < fadeZone) {
                opacity = distanceFromRight / fadeZone;
                scale = 0.9 + 0.1 * opacity;
              }
            }

            // Rajoita läpinäkyvyys välille 0.1-1 ja aseta se
            opacity = Math.max(0.1, Math.min(1, opacity));

            // Käytä transform: translate3d() hardware-acceleration varten
            item.style.opacity = opacity;
            item.style.transform = `translate3d(0,0,0) scale(${scale})`;
          });
        });
      }

      // Tallenna allekirjoitukset localStorageen
      function saveSignaturesToLocal(name, images, color) {
        const signatureData = {
          name,
          images,
          color,
          createdAt: new Date().toISOString(),
        };

        localStorage.setItem("signatures", JSON.stringify(signatureData));
        console.log("Signatures saved to localStorage with color:", color);
      }

      // Hae allekirjoitukset localStoragesta
      function getSignaturesFromLocal() {
        const data = localStorage.getItem("signatures");
        return data ? JSON.parse(data) : null;
      }

      // Lisää tämä funktio allekirjoitusten vanhenemisajan asettamiseksi
      function setSignatureExpiry() {
        const expiryTime = Date.now() + 10 * 60 * 1000; // Nykyinen aika + 1 minuuttia
        localStorage.setItem("signatureExpiry", expiryTime.toString());
        console.log(
          "Signature expiry time set:",
          new Date(expiryTime).toLocaleTimeString()
        );
      }

      // Tarkista onko allekirjoitukset vanhentuneet
      function areSignaturesExpired() {
        const expiryTime = localStorage.getItem("signatureExpiry");
        if (!expiryTime) return false;

        const now = Date.now();
        const expired = now > parseInt(expiryTime);

        return expired;
      }

      // Päivitä käyttöliittymä tilan mukaan
      function updateUI(status) {
        if (status.hasSignatures) {
          // Näytä allekirjoitukset
          const signatures = getSignaturesFromLocal();

          if (signatures && signatures.images) {
            signaturesContainer.innerHTML = "";
            signaturesContainer.classList.add("signatures-container");

            signatures.images.forEach((image, index) => {
              const signatureDiv = document.createElement("div");
              signatureDiv.className = "signature-item";

              const img = document.createElement("img");
              img.src = image;
              img.alt = `Signature ${index + 1}`;
              img.style.maxWidth = "100%";
              img.style.height = "auto";

              signatureDiv.appendChild(img);
              signaturesContainer.appendChild(signatureDiv);
            });

            // Näytä ostonappi jos ei ole vielä maksettu
            if (!status.hasPaid) {
              buyButton.style.display = "inline-block";
              statusMessage.textContent = "Signatures created successfully!";
              statusMessage.style.color = "#4CAF50";
            } else {
              buyButton.style.display = "none";
              statusMessage.textContent =
                "Payment successful! You can download your signatures.";
              statusMessage.style.color = "#4CAF50";
            }

            // Näytä sähköpostikenttä
            emailContainer.classList.remove("hidden");
          }
        } else {
          // Tyhjennä allekirjoituskontti
          signaturesContainer.innerHTML = "";

          // Piilota ostonappi
          buyButton.style.display = "none";

          // Piilota sähköpostikenttä
          emailContainer.classList.add("hidden");

          // Piilota latausnappi
          downloadAgainContainer.classList.add("hidden");

          // Nollaa statusviesti
          statusMessage.textContent = "";
        }

        // Näytä resetointinappi jos on allekirjoituksia
        if (status.hasSignatures) {
          resetContainer.classList.remove("hidden");
        } else {
          resetContainer.classList.add("hidden");
        }
      }

      // Tarkista sovelluksen tila
      async function checkStatus(forceCheck = false) {
        // Tarkista onko allekirjoitukset vanhentuneet
        if (areSignaturesExpired()) {
          await resetSignatures();
          return;
        }

        // Tarkista onko allekirjoituksia localStoragessa
        const signatures = getSignaturesFromLocal();
        const hasPaid = getPaymentStatus();

        // Päivitä käyttöliittymä tilan mukaan
        updateUI({
          hasSignatures: !!signatures,
          hasPaid,
          canDownload: hasPaid,
        });

        // Jos käyttäjä on maksanut ja allekirjoitukset ovat olemassa, näytä latausnappi
        if (hasPaid && signatures) {
          downloadAgainContainer.classList.remove("hidden");

          // Tarkista onko automaattinen lataus jo tehty
          const hasAutoDownloaded = localStorage.getItem("hasAutoDownloaded");

          // Jos ei ole vielä ladattu automaattisesti ja forceCheck on true (maksu juuri tehty)
          if (!hasAutoDownloaded && forceCheck) {
            await downloadSignatures();
            localStorage.setItem("hasAutoDownloaded", "true");
          }
        }
      }

      // Muokkaa createSignatures-funktiota asettamaan vanhenemisaika
      async function createSignatures() {
        const name = nameInput.value.trim();
        const color = document.querySelector(
          'input[name="color"]:checked'
        ).value;

        if (!name) {
          alert("Write your name first!");
          return;
        }

        // Näytä latausviesti
        statusMessage.textContent = "Creating signatures...";
        statusMessage.style.color = "#6e8efb"; // Sininen väri

        try {
          // Luo allekirjoitukset
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, color }),
          });

          const data = await response.json();

          // Varmista että signaturesContainer-elementti saa oikean tyylin
          signaturesContainer.classList.add("signatures-container");

          if (data.images && data.images.length > 0) {
            // Tyhjennä aiemmat allekirjoitukset
            signaturesContainer.innerHTML = "";

            // Lisää uudet allekirjoitukset
            data.images.forEach((image, index) => {
              const signatureDiv = document.createElement("div");
              signatureDiv.className = "signature-item";

              const img = document.createElement("img");
              img.src = image;
              img.alt = `Signature ${index + 1}`;
              img.style.maxWidth = "100%";
              img.style.height = "auto";

              signatureDiv.appendChild(img);
              signaturesContainer.appendChild(signatureDiv);
            });

            // Tallenna allekirjoitukset localStorageen
            saveSignaturesToLocal(name, data.images, color);

            // Aseta 10 minuutin vanhenemisaika
            setSignatureExpiry();

            // Näytä ostonappi
            buyButton.style.display = "inline-block";

            // Näytä viesti
            statusMessage.textContent = "Signatures created successfully!";
            statusMessage.style.color = "#4CAF50"; // Vihreä väri
          }
        } catch (error) {
          statusMessage.textContent = "Error creating signatures.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Muokataan downloadSignatures-funktiota
      async function downloadSignatures() {
        try {
          const signatures = getSignaturesFromLocal();

          if (
            !signatures ||
            !signatures.images ||
            signatures.images.length === 0
          ) {
            alert("No signatures to download!");
            return;
          }

          // Luo ZIP-tiedosto
          const zip = new JSZip();

          // Lisää kuvat ZIP-tiedostoon
          signatures.images.forEach((image, index) => {
            // Poista data URL:n alku
            const imageData = image.replace(/^data:image\/png;base64,/, "");
            zip.file(`signature-${index + 1}.png`, imageData, { base64: true });
          });

          // Generoi ZIP-tiedosto
          const content = await zip.generateAsync({ type: "blob" });

          // Luo latauslinkki
          const link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = `signatures-${signatures.name.replace(
            /\s+/g,
            "-"
          )}.zip`;

          // Simuloi klikkausta
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          alert("Error downloading signatures!");
        }
      }

      // Muokataan checkExistingSignatures-funktiota
      function checkExistingSignatures() {
        const signatures = getSignaturesFromLocal();

        if (signatures && signatures.images && signatures.images.length > 0) {
          console.log("Found existing signatures:", signatures);

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          signatures.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${signatures.name} signature`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Täytä nimi-kenttä
          nameInput.value = signatures.name;

          // Aseta tallennettu väri
          if (signatures.color) {
            // Etsi oikea värivaihtoehto ja valitse se
            const colorRadio = document.querySelector(
              `input[name="color"][value="${signatures.color}"]`
            );
            if (colorRadio) {
              colorRadio.checked = true;
            }
          }

          // Tarkista tila uudelleen
          checkStatus();

          return true;
        }

        return false;
      }

      // Muokataan resetAllData-funktiota
      async function resetAllData() {
        // Poista kaikki tiedot localStoragesta
        localStorage.removeItem("signatures");
        localStorage.removeItem("hasPaid");
        localStorage.removeItem("paymentExpiry");
        localStorage.removeItem("signatureExpiry");
        localStorage.removeItem("hasAutoDownloaded");
        // Älä poista sessionId:tä, jotta käyttäjä voidaan tunnistaa jatkossakin

        // Tyhjennä allekirjoitukset
        signaturesContainer.innerHTML = "";

        // Tyhjennä nimi
        nameInput.value = "";

        // Piilota napit ja viestit
        buyButton.style.display = "none";
        downloadAgainContainer.style.display = "none";
        emailContainer.style.display = "none";
        resetContainer.style.display = "none";

        // Näytä viesti
        statusMessage.textContent = "Data deleted. Redirecting to homepage...";
        statusMessage.style.color = "#4CAF50"; // Vihreä väri

        // Pysäytä ajastin
        if (resetTimerInterval) {
          clearInterval(resetTimerInterval);
        }

        // Pieni viive ennen ohjausta etusivulle
        setTimeout(() => {
          // Ohjaa käyttäjä etusivulle ja pakota sivu latautumaan uudelleen
          window.location.href =
            window.location.origin + window.location.pathname + "?reset=true";
        }, 1500);
      }

      // Muokataan createCheckoutSession-funktiota
      async function createCheckoutSession() {
        const signatures = getSignaturesFromLocal();
        const sessionId = await getSessionId(); // Käytä uutta funktiota

        if (!signatures) {
          alert("Create signatures first!");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/api/create-checkout-session`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: signatures.name,
                sessionId: sessionId,
              }),
            }
          );

          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error("Checkout URL missing from response");
          }
        } catch (error) {
          console.error("Error handling payment:", error);
          alert("Error handling payment.");
        }
      }

      // Lisää tapahtumankäsittelijä painikkeelle
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const sessionId = await getSessionId();

        if (!email) {
          alert("Enter your email first!");
          return;
        }

        try {
          // Näytä latausanimaatio tai teksti
          sendEmailButton.disabled = true;
          sendEmailButton.textContent = "Sending...";

          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              sessionId,
              // Lisää allekirjoitukset pyyntöön
              signatures: getSignaturesFromLocal(),
            }),
          });

          // Palauta nappi normaaliksi
          sendEmailButton.textContent = "Send signatures to email";

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Error sending email");
          }

          const data = await response.json();

          if (data.success) {
            alert("Signatures sent to your email!");
          } else {
            alert("Error sending email.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `You can send the email again in ${timeLeft} seconds.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `You can send the email again in ${timeLeft} seconds.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          alert(`Error sending email: ${error.message}`);
          sendEmailButton.disabled = false;
          sendEmailButton.textContent = "Send signatures to email";
        }
      });

      // Lataa oma fontti dynaamisesti ja alusta karuselli vasta kun fontti on ladattu
      async function loadFontsAndInitialize() {
        try {
          // Tyhjennä fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lisää oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });
          } catch (fontError) {
            // Jos oman fontin lataus epäonnistuu, käytä järjestelmäfonttia
            signatureFonts.push({
              name: "Järjestelmäfontti",
              font: "60px Arial, sans-serif",
            });
          }

          // Alusta karuselli vasta kun fontit on ladattu
          await initializeCarousel();

          // Tarkista onko käyttäjällä jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          // Virhetilanteessa alusta karuselli järjestelmäfontilla
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "Järjestelmäfontti",
            font: "60px Arial, sans-serif",
          });
          initializeCarousel();
        }
      }

      // Käynnistä fonttien lataus ja alustus
      async function initialize() {
        // Tallenna IP-osoite heti alussa
        await saveSessionId();
        await loadFontsAndInitialize();

        // Tarkista maksun tila ensin
        await checkPaymentStatus();

        // Tarkista tila vasta kun IP on tallennettu
        await checkStatus();
      }

      // Käynnistä sovellus
      initialize();

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Tarkista maksun tila sivun latautuessa
      async function checkPaymentStatus() {
        // Tarkista onko maksu vanhentunut
        if (isPaymentExpired()) {
          await resetAllData();
          return;
        }

        if (getQueryParam("success") === "true") {
          const hasPaid = getPaymentStatus();

          if (!hasPaid) {
            savePaymentStatus(true);

            // Tallenna maksun aikaleima vain jos sitä ei ole jo asetettu
            if (!localStorage.getItem("paymentExpiry")) {
              savePaymentTimestamp();
            }

            // Nollaa automaattisen latauksen tila, jos käyttäjä on juuri maksanut
            localStorage.removeItem("hasAutoDownloaded");
          }

          checkStatus(true);
        } else if (getQueryParam("canceled") === "true") {
          statusMessage.textContent = "Payment canceled.";
        }
      }

      // Lisää tapahtumankäsittelijä "Lataa uudelleen" -napille
      downloadAgainButton.addEventListener("click", async () => {
        await downloadSignatures();
      });

      // Tarkista tila säännöllisesti, mutta varmista että IP on haettu
      setTimeout(() => {
        setInterval(checkStatus, 2000);
        checkStatus();
      }, 1000);

      // Ajastimen muuttujat
      let resetTimerInterval;
      let resetTimeLeft = 180; // 3 minuuttia sekunteina

      // Funktio ajastimen päivittämiseen
      function updateResetTimer() {
        // Hae jäljellä oleva aika localStoragesta
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) {
          resetTimer.textContent =
            "Data will be automatically deleted in 3:00 minutes";
          return;
        }

        const now = Date.now();
        const timeLeft = Math.max(0, parseInt(expiryTime) - now);

        // Muunna millisekunnit minuuteiksi ja sekunneiksi
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);

        resetTimer.textContent = `Data will be automatically deleted in ${minutes}:${
          seconds < 10 ? "0" : ""
        }${seconds} minutes`;

        if (timeLeft <= 0) {
          clearInterval(resetTimerInterval);
          resetAllData();
        }
      }

      // Lisää tapahtumankäsittelijä "Luo lisää allekirjoituksia" -napille
      resetButton.addEventListener("click", resetAllData);

      // Tarkista onko sivu ladattu resetoinnin jälkeen
      if (getQueryParam("reset") === "true") {
        console.log("Page loaded after reset");
        // Poista reset-parametri URL:sta ilman sivun uudelleenlatausta
        const url = new URL(window.location);
        url.searchParams.delete("reset");
        window.history.replaceState({}, document.title, url);
      }

      // Lisää tapahtumankäsittelijä ostonapille
      buyButton.addEventListener("click", async () => {
        await createCheckoutSession();
      });

      // Varmista, että tarkistus suoritetaan säännöllisesti
      setTimeout(() => {
        // Tarkista tila heti kerran
        checkStatus();

        // Aseta ajastin tarkistamaan tila säännöllisesti
        setInterval(() => {
          checkStatus();
        }, 10000); // Tarkista 10 sekunnin välein
      }, 1000);

      // Lisää myös tarkistus sivun latautuessa
      window.addEventListener("load", () => {
        checkStatus();
      });

      // Lisää tarkistus myös kun sivu tulee takaisin näkyviin
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          checkStatus();
        }
      });
    </script>
  </body>
</html>
