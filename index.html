<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Allekirjoitusgeneraattori</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        padding-bottom: 0px !important;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        width: 100%;
      }

      input[type="text"] {
        width: 60%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
        margin-bottom: 0px !important;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }

        input[type="text"] {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto 40px auto;
        overflow: hidden;
        position: relative;
      }

      .signature-carousel {
        display: flex;
        transition: transform 0.5s ease;
        gap: 30px;
        padding: 10px 100px;
      }

      .carousel-item {
        min-width: 250px;
        height: 150px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        will-change: transform, opacity;
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      .carousel-item img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        display: block;
        will-change: transform;
        transform: translateZ(0);
      }

      @media (max-width: 1200px) {
        .carousel-item {
          min-width: calc(33.333% - 20px);
        }
      }

      @media (max-width: 900px) {
        .signature-carousel-container {
          margin-bottom: 30px;
        }

        .signature-carousel {
          padding: 10px 20px;
          gap: 15px;
          scroll-snap-type: x mandatory;
        }

        .carousel-item {
          min-width: 180px;
          height: 120px;
          scroll-snap-align: center;
          background-color: rgba(255, 255, 255, 0.2);
        }

        .carousel-item.active {
          opacity: 1 !important;
          transform: scale(1.05) !important;
        }
      }

      @media (max-width: 600px) {
        .signature-carousel {
          padding: 10px 10px;
        }

        .carousel-item {
          min-width: 160px;
          height: 100px;
        }
      }

      /* Lisää oma fontti @font-face-säännöllä */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }

      /* Lisää nämä tyylit allekirjoituskuville */
      .signature-image {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }

      /* Varmista että allekirjoituskontti mukautuu mobiililaitteille */
      .signature-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
      }

      /* Varmista että kuvat eivät koskaan mene yli ruudun */
      img {
        max-width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Handwritten Signature Generator</h1>
    <p>Generate beautiful handwritten signatures easily</p>

    <!-- Lisätään allekirjoituskaruselli -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <!-- Karusellin sisältö täytetään JavaScriptillä -->
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Write your name here..."
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Create signatures
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Buy signatures (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Do you want to receive the signatures to your email?</h2>
      <input type="email" id="emailInput" placeholder="Your email address" />
      <button id="sendEmailButton">Send signatures to email</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <div
      id="download-again-container"
      class="email-container"
      style="display: none"
    >
      <button id="downloadAgainButton" class="button primary-button">
        Download signatures again
      </button>
    </div>

    <div id="reset-container" class="email-container" style="display: none">
      <div id="reset-timer" class="status-message">
        Data will be automatically deleted in 3:00 minutes
      </div>
      <button id="resetButton" class="button primary-button">
        Create more signatures
      </button>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");
      const downloadAgainContainer = document.getElementById(
        "download-again-container"
      );
      const downloadAgainButton = document.getElementById(
        "downloadAgainButton"
      );
      const resetContainer = document.getElementById("reset-container");
      const resetButton = document.getElementById("resetButton");
      const resetTimer = document.getElementById("reset-timer");

      // Fontit allekirjoituksille - alusta tyhjä lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Emma Johnson",
        "James Smith",
        "Olivia Williams",
        "Liam Brown",
        "Sophia Davis",
        "Benjamin Wilson",
        "Charlotte Miller",
        "Ethan Moore",
        "Isabella Taylor",
        "Mason Anderson",
        "Mia Thomas",
        "Alexander Harris",
        "Amelia Martin",
        "Daniel Thompson",
        "Harper White",
        "Henry Clark",
        "Evelyn Rodriguez",
        "Michael Lewis",
        "Abigail Walker",
        "Lucas Hall",
        "Emily Allen",
        "William Young",
        "Scarlett King",
        "Elijah Scott",
        "Grace Wright",
        "Oliver Green",
      ];

      // Muutetaan funktioiden nimet vastaamaan niiden toimintaa
      async function saveSessionId() {
        try {
          // Tarkista onko sessionId jo olemassa
          let sessionId = localStorage.getItem("sessionId");

          // Jos ei ole, hae uusi
          if (!sessionId) {
            const response = await fetch(`${API_URL}/api/get-session-id`);
            sessionId = await response.text();
            localStorage.setItem("sessionId", sessionId);
          }

          console.log("Session ID saved to localStorage:", sessionId);
          return sessionId;
        } catch (error) {
          console.error("Error saving session ID:", error);
          return null;
        }
      }

      // Hae tallennettu session ID tai hae uusi
      async function getSessionId() {
        let sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
          sessionId = await saveSessionId();
        }
        return sessionId;
      }

      // Tallenna maksutila localStorageen
      function savePaymentStatus(isPaid) {
        localStorage.setItem("hasPaid", isPaid ? "true" : "false");
        console.log("Payment status saved to localStorage:", isPaid);
      }

      // Hae maksutila localStoragesta
      function getPaymentStatus() {
        return localStorage.getItem("hasPaid") === "true";
      }

      // Tallenna maksun aikaleima
      function savePaymentTimestamp() {
        const expiryTime = Date.now() + 3 * 60 * 1000; // Nykyinen aika + 3 minuuttia
        localStorage.setItem("paymentExpiry", expiryTime.toString());
        console.log(
          "Payment expiry time saved:",
          new Date(expiryTime).toLocaleTimeString()
        );
      }

      // Tarkista onko maksu vanhentunut
      function isPaymentExpired() {
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) return false;

        const now = Date.now();
        const expired = now > parseInt(expiryTime);

        console.log(
          "Payment expiry time:",
          new Date(parseInt(expiryTime)).toLocaleTimeString()
        );
        console.log("Current time:", new Date(now).toLocaleTimeString());
        console.log("Payment expired:", expired);

        return expired;
      }

      // Luo allekirjoitukset karuselliin
      async function initializeCarousel() {
        // Tyhjennä karuselli
        signatureCarousel.innerHTML = "";

        // Odota että fontit on ladattu
        await document.fonts.ready;

        // Varmista että käyttäjän IP on tallennettu
        await getSessionId();

        console.log("Initializing carousel using static images");

        // Luo esimerkkiallekirjoitukset ja lisää ne karuselliin
        const signatures = [];

        // Käytä staattisia kuvia
        try {
          // Käytä kaikkia 26 kuvaa
          const totalImages = 26;

          for (let i = 0; i < totalImages; i++) {
            // Käytä exampleNames-taulukon nimiä, jos saatavilla, muuten käytä geneerisiä nimiä
            const name =
              i < exampleNames.length ? exampleNames[i] : `Esimerkki ${i + 1}`;

            // Käytä staattista kuvaa
            const imagePath = `/signatures/handwritten_signature_generator_example_${
              i + 1
            }.png`;

            signatures.push({
              name,
              image: imagePath,
              font: "Oma Fontti",
            });
          }

          // Jos ei saatu yhtään allekirjoitusta, näytä virheilmoitus
          if (signatures.length === 0) {
            const message = document.createElement("div");
            message.className = "carousel-item";
            message.textContent = "Failed to load example signatures.";
            signatureCarousel.appendChild(message);
            return;
          }

          console.log(`Loaded ${signatures.length} example signatures`);

          // Lisää allekirjoitukset karuselliin
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} signature (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Lisää samat allekirjoitukset uudelleen, jotta karuselli näyttää jatkuvalta
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";
            imgContainer.style.opacity = "0.5";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `Handwritten signature genetator example with the name of ${signature.name}`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Käynnistä karusellin animaatio
          startCarouselAnimation();
        } catch (error) {
          console.error("Virhe karusellin alustuksessa:", error);
          const message = document.createElement("div");
          message.className = "carousel-item";
          message.textContent = "Error loading example signatures.";
          signatureCarousel.appendChild(message);
        }
      }

      // Karusellin animaatio
      let carouselPosition = 0;
      let carouselAnimationId;
      let isResetting = false;

      function startCarouselAnimation() {
        if (carouselAnimationId) {
          cancelAnimationFrame(carouselAnimationId);
        }

        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const totalItems = items.length;
        const visibleItems = 3; // Näkyvien elementtien määrä
        const itemWidth = 280; // Elementin leveys + marginaali
        const duration = 60000; // Koko kierroksen kesto millisekunteina
        const step = ((itemWidth * exampleNames.length) / duration) * 16.7; // Siirtymä per frame
        const containerWidth = document.querySelector(
          ".signature-carousel-container"
        ).offsetWidth;

        // Aseta alkuposition niin, että ensimmäinen elementti on näkyvissä
        carouselPosition = 0;

        function animateCarousel() {
          if (!isResetting) {
            carouselPosition -= step;

            // Kun karuselli on liikkunut tarpeeksi, valmistele paluu alkuun
            if (carouselPosition <= -itemWidth * exampleNames.length) {
              isResetting = true;

              // Poista transition väliaikaisesti
              signatureCarousel.style.transition = "none";

              // Aseta timeout, jotta transition-muutos ehtii vaikuttaa
              setTimeout(() => {
                // Nollaa positio
                carouselPosition = 0;
                signatureCarousel.style.transform = `translate3d(${carouselPosition}px, 0, 0)`;

                // Palauta transition pienen viiveen jälkeen
                setTimeout(() => {
                  signatureCarousel.style.transition = "transform 0.5s ease";
                  isResetting = false;
                }, 20);
              }, 20);
            }
          }

          // Päivitä karusellin sijainti
          if (!isResetting) {
            signatureCarousel.style.transform = `translate3d(${carouselPosition}px, 0, 0)`;

            // Päivitä elementtien läpinäkyvyys sijainnin perusteella
            updateItemsOpacity(containerWidth);
          }

          carouselAnimationId = requestAnimationFrame(animateCarousel);
        }

        carouselAnimationId = requestAnimationFrame(animateCarousel);
      }

      // Optimoi updateItemsOpacity-funktiota
      function updateItemsOpacity(containerWidth) {
        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const fadeZone = 150;
        const isMobile = window.innerWidth <= 900;

        // Käytä requestAnimationFrame optimoimaan animaatiot
        requestAnimationFrame(() => {
          // Poista active-luokka kaikilta
          items.forEach((item) => item.classList.remove("active"));

          items.forEach((item) => {
            const rect = item.getBoundingClientRect();
            const containerRect =
              signatureCarousel.parentElement.getBoundingClientRect();

            // Laske keskikohta
            const itemCenter = rect.left + rect.width / 2;
            const containerCenter =
              containerRect.left + containerRect.width / 2;
            const distanceFromCenter = Math.abs(itemCenter - containerCenter);

            // Oletusarvot
            let opacity = 1;
            let scale = 1;

            // Jos mobiili, käytä yksinkertaisempaa logiikkaa
            if (isMobile) {
              // Vähennä animaatioiden määrää mobiilissa
              // Käytä vain kolmea tilaa: aktiivinen, lähellä, kaukana
              if (distanceFromCenter < rect.width / 2) {
                // Keskellä oleva elementti
                item.classList.add("active");
                opacity = 1;
                scale = 1.05;
              } else if (distanceFromCenter < rect.width * 1.5) {
                // Lähellä keskustaa olevat elementit
                opacity = 0.6;
                scale = 0.95;
              } else {
                // Kaukana olevat elementit
                opacity = 0.3;
                scale = 0.9;
              }
            } else {
              // Työpöytäversio
              const distanceFromLeft = rect.left - containerRect.left;
              const distanceFromRight = containerRect.right - rect.right;

              if (distanceFromLeft < fadeZone) {
                opacity = distanceFromLeft / fadeZone;
                scale = 0.9 + 0.1 * opacity;
              } else if (distanceFromRight < fadeZone) {
                opacity = distanceFromRight / fadeZone;
                scale = 0.9 + 0.1 * opacity;
              }
            }

            // Rajoita läpinäkyvyys välille 0.1-1 ja aseta se
            opacity = Math.max(0.1, Math.min(1, opacity));

            // Käytä transform: translate3d() hardware-acceleration varten
            item.style.opacity = opacity;
            item.style.transform = `translate3d(0,0,0) scale(${scale})`;
          });
        });
      }

      // Tallenna allekirjoitukset localStorageen
      function saveSignaturesToLocal(name, images, color) {
        const signatureData = {
          name,
          images,
          color,
          createdAt: new Date().toISOString(),
        };

        localStorage.setItem("signatures", JSON.stringify(signatureData));
        console.log("Signatures saved to localStorage with color:", color);
      }

      // Hae allekirjoitukset localStoragesta
      function getSignaturesFromLocal() {
        const data = localStorage.getItem("signatures");
        return data ? JSON.parse(data) : null;
      }

      // Lisää tämä funktio allekirjoitusten vanhenemisajan asettamiseksi
      function setSignatureExpiry() {
        const expiryTime = Date.now() + 10 * 60 * 1000; // Nykyinen aika + 1 minuuttia
        localStorage.setItem("signatureExpiry", expiryTime.toString());
        console.log(
          "Signature expiry time set:",
          new Date(expiryTime).toLocaleTimeString()
        );
      }

      // Lisää tämä funktio allekirjoitusten vanhenemisen tarkistamiseksi
      function isSignatureExpired() {
        // Jos maksu on suoritettu, käytä maksun vanhenemisaikaa
        if (getPaymentStatus()) {
          return isPaymentExpired();
        }

        const expiryTime = localStorage.getItem("signatureExpiry");
        if (!expiryTime) return false;

        const now = Date.now();
        const expired = now > parseInt(expiryTime);

        console.log(
          "Allekirjoitusten vanhenemisaika:",
          new Date(parseInt(expiryTime)).toLocaleTimeString()
        );
        console.log("Nykyinen aika:", new Date(now).toLocaleTimeString());
        console.log("Allekirjoitukset vanhentuneet:", expired);

        return expired;
      }

      // Muokkaa createSignatures-funktiota asettamaan vanhenemisaika
      async function createSignatures() {
        const name = nameInput.value.trim();
        if (!name) {
          alert("Please enter your name first!");
          return;
        }

        try {
          // Näytä latausanimaatio
          generateSignaturesButton.disabled = true;
          generateSignaturesButton.textContent = "Creating...";
          signaturesContainer.innerHTML =
            '<div class="loading">Creating your signatures...</div>';

          // Hae session ID
          const sessionId = await getSessionId();

          // Lähetä pyyntö palvelimelle
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name,
              sessionId,
              color: document.querySelector('input[name="color"]:checked')
                .value,
            }),
          });

          // Palauta nappi normaaliksi
          generateSignaturesButton.textContent = "Create signatures";
          generateSignaturesButton.disabled = false;

          if (!response.ok) {
            throw new Error("Failed to create signatures");
          }

          const data = await response.json();

          if (data.success) {
            // Tyhjennä allekirjoituskontti
            signaturesContainer.innerHTML = "";

            // Lisää allekirjoitukset oikeilla CSS-luokilla
            data.signatures.forEach((signatureUrl, index) => {
              const signatureDiv = document.createElement("div");
              signatureDiv.className = "signature-container";

              const img = document.createElement("img");
              img.src = signatureUrl;
              img.alt = `Signature ${index + 1}`;
              img.className = "signature-image"; // Tärkeä luokka mobiiliyhteensopivuudelle

              signatureDiv.appendChild(img);
              signaturesContainer.appendChild(signatureDiv);
            });

            // Tallenna allekirjoitukset localStorageen
            localStorage.setItem(
              "signatures",
              JSON.stringify({
                name,
                images: data.signatures,
                color: document.querySelector('input[name="color"]:checked')
                  .value,
                createdAt: new Date().toISOString(),
              })
            );

            // Näytä osto- ja sähköpostipainikkeet
            buyButton.classList.remove("hidden");
            emailContainer.classList.remove("hidden");
            statusMessage.textContent = "Signatures created!";
            statusMessage.style.color = "#4CAF50";
          } else {
            throw new Error(data.error || "Failed to create signatures");
          }
        } catch (error) {
          console.error("Error creating signatures:", error);
          signaturesContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
          statusMessage.textContent = "Error creating signatures.";
          statusMessage.style.color = "#f44336";
        }
      }

      // Tarkista tila
      async function checkStatus(forceCheck = false) {
        // Tarkista onko allekirjoitukset vanhentuneet
        if (isSignatureExpired()) {
          console.log("Allekirjoitukset vanhentuneet, tyhjennetään tiedot...");
          await resetAllData();
          return;
        }

        // Tarkista onko maksu vanhentunut
        if (isPaymentExpired()) {
          console.log("Maksu vanhentunut, tyhjennetään tiedot...");
          await resetAllData();
          return;
        }

        // Tarkista localStoragesta
        const signatures = getSignaturesFromLocal();
        const hasPaid = getPaymentStatus();

        console.log("Checking status from localStorage:");
        console.log("- Signatures:", !!signatures);
        console.log("- Paid:", hasPaid);

        const data = {
          hasSignatures: !!signatures,
          hasPaid: hasPaid,
          canDownload: !!signatures && hasPaid,
        };

        console.log("Status updated:", data);

        if (data.hasSignatures) {
          if (data.hasPaid && data.canDownload) {
            console.log("Payment confirmed, signatures available for download");
            statusMessage.textContent =
              "Payment successful! Signatures available for download.";
            statusMessage.style.color = "#4CAF50"; // Vihreä väri
            buyButton.style.display = "none";

            // Näytä "Lataa uudelleen" -nappi
            downloadAgainContainer.style.display = "block";

            // Näytä sähköpostikenttä
            emailContainer.style.display = "block";

            // Näytä reset-container ja käynnistä ajastin
            resetContainer.style.display = "block";

            // Käynnistä ajastin vain jos sitä ei ole jo käynnistetty
            if (!resetTimerInterval) {
              resetTimeLeft = 180; // 3 minuuttia
              updateResetTimer(); // Päivitä heti kerran
              resetTimerInterval = setInterval(updateResetTimer, 1000);
            }

            // Tarkista onko automaattinen lataus jo suoritettu
            const hasAutoDownloaded = localStorage.getItem("hasAutoDownloaded");

            if (forceCheck && !hasAutoDownloaded) {
              // Merkitse automaattinen lataus suoritetuksi
              localStorage.setItem("hasAutoDownloaded", "true");

              // Viive ennen latausta, jotta käyttäjä näkee viestin
              setTimeout(() => {
                downloadSignatures();
              }, 1000);
            }
          } else {
            // Näytä viesti vain jos käyttäjä on luonut allekirjoitukset
            if (signaturesContainer.innerHTML.trim() !== "") {
              statusMessage.textContent = "Signatures created!";
              statusMessage.style.color = "#6e8efb"; // Sininen väri
              buyButton.style.display = "inline-block";

              // Piilota "Lataa uudelleen" -nappi ja reset-container
              downloadAgainContainer.style.display = "none";
              resetContainer.style.display = "none";

              // Pysäytä ajastin
              if (resetTimerInterval) {
                clearInterval(resetTimerInterval);
                resetTimerInterval = null;
              }
            }
          }
        } else {
          // Ei allekirjoituksia, piilota ostonappi
          buyButton.style.display = "none";
          statusMessage.textContent = "";

          // Piilota "Lataa uudelleen" -nappi ja reset-container
          downloadAgainContainer.style.display = "none";
          resetContainer.style.display = "none";

          // Pysäytä ajastin
          if (resetTimerInterval) {
            clearInterval(resetTimerInterval);
            resetTimerInterval = null;
          }
        }
      }

      // Muokataan downloadSignatures-funktiota
      async function downloadSignatures() {
        try {
          // Hae allekirjoitukset localStoragesta
          const signatures = getSignaturesFromLocal();

          if (!signatures || !signatures.images || !signatures.images.length) {
            throw new Error("No signatures found in localStorage");
          }

          console.log("Downloading clean signatures...");

          // Hae puhtaat allekirjoitukset palvelimelta
          const response = await fetch(
            `${API_URL}/api/create-clean-signatures`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: signatures.name,
                color: signatures.color,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(
              `Error creating clean signatures: ${response.status}`
            );
          }

          const cleanData = await response.json();

          // Luo ZIP-tiedosto
          const zip = new JSZip();

          // Lisää puhtaat kuvat ZIP-tiedostoon
          cleanData.images.forEach((imageData, index) => {
            // Poista data:image/png;base64, -etuliite
            const base64Data = imageData.replace(
              /^data:image\/png;base64,/,
              ""
            );
            zip.file(`allekirjoitus_${index + 1}.png`, base64Data, {
              base64: true,
            });
          });

          // Generoi ZIP-tiedosto
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // Luo latauslinkki
          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(zipBlob);
          downloadLink.download = `allekirjoitukset_${signatures.name.replace(
            /\s+/g,
            "_"
          )}.zip`;

          // Simuloi klikkausta
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          console.log("Signatures downloaded successfully");
          statusMessage.textContent = "Signatures downloaded successfully!";
          statusMessage.style.color = "#4CAF50"; // Vihreä väri
        } catch (error) {
          console.error("Error downloading signatures:", error);
          statusMessage.textContent = "Error downloading signatures.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Muokataan checkExistingSignatures-funktiota
      function checkExistingSignatures() {
        const signatures = getSignaturesFromLocal();

        if (signatures && signatures.images && signatures.images.length > 0) {
          console.log("Found existing signatures:", signatures);

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          signatures.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${signatures.name} signature`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Täytä nimi-kenttä
          nameInput.value = signatures.name;

          // Aseta tallennettu väri
          if (signatures.color) {
            // Etsi oikea värivaihtoehto ja valitse se
            const colorRadio = document.querySelector(
              `input[name="color"][value="${signatures.color}"]`
            );
            if (colorRadio) {
              colorRadio.checked = true;
            }
          }

          // Tarkista tila uudelleen
          checkStatus();

          return true;
        }

        return false;
      }

      // Muokataan resetAllData-funktiota
      async function resetAllData() {
        // Poista kaikki tiedot localStoragesta
        localStorage.removeItem("signatures");
        localStorage.removeItem("hasPaid");
        localStorage.removeItem("paymentExpiry");
        localStorage.removeItem("signatureExpiry");
        localStorage.removeItem("hasAutoDownloaded");
        // Älä poista sessionId:tä, jotta käyttäjä voidaan tunnistaa jatkossakin

        // Tyhjennä allekirjoitukset
        signaturesContainer.innerHTML = "";

        // Tyhjennä nimi
        nameInput.value = "";

        // Piilota napit ja viestit
        buyButton.style.display = "none";
        downloadAgainContainer.style.display = "none";
        emailContainer.style.display = "none";
        resetContainer.style.display = "none";

        // Näytä viesti
        statusMessage.textContent = "Data deleted. Redirecting to homepage...";
        statusMessage.style.color = "#4CAF50"; // Vihreä väri

        // Pysäytä ajastin
        if (resetTimerInterval) {
          clearInterval(resetTimerInterval);
        }

        // Pieni viive ennen ohjausta etusivulle
        setTimeout(() => {
          // Ohjaa käyttäjä etusivulle ja pakota sivu latautumaan uudelleen
          window.location.href =
            window.location.origin + window.location.pathname + "?reset=true";
        }, 1500);
      }

      // Muokataan createCheckoutSession-funktiota
      async function createCheckoutSession() {
        const signatures = getSignaturesFromLocal();
        const sessionId = await getSessionId(); // Käytä uutta funktiota

        if (!signatures) {
          alert("Create signatures first!");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/api/create-checkout-session`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: signatures.name,
                sessionId: sessionId,
              }),
            }
          );

          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error("Checkout URL missing from response");
          }
        } catch (error) {
          console.error("Error handling payment:", error);
          alert("Error handling payment.");
        }
      }

      // Lisää tapahtumankäsittelijä painikkeelle
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const sessionId = await getSessionId();

        if (!email) {
          alert("Enter your email first!");
          return;
        }

        try {
          // Näytä latausanimaatio tai teksti
          sendEmailButton.disabled = true;
          sendEmailButton.textContent = "Sending...";

          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              sessionId,
              // Lisää allekirjoitukset pyyntöön
              signatures: getSignaturesFromLocal(),
            }),
          });

          // Palauta nappi normaaliksi
          sendEmailButton.textContent = "Send signatures to email";

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Error sending email");
          }

          const data = await response.json();

          if (data.success) {
            alert("Signatures sent to your email!");
          } else {
            alert("Error sending email.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `You can send the email again in ${timeLeft} seconds.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `You can send the email again in ${timeLeft} seconds.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Error sending email:", error);
          alert(`Error sending email: ${error.message}`);
          sendEmailButton.disabled = false;
          sendEmailButton.textContent = "Send signatures to email";
        }
      });

      // Lataa oma fontti dynaamisesti ja alusta karuselli vasta kun fontti on ladattu
      async function loadFontsAndInitialize() {
        try {
          // Tyhjennä fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lisää oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });

            console.log("Own font loaded successfully!");
          } catch (fontError) {
            console.error("Error loading own font:", fontError);
            // Jos oman fontin lataus epäonnistuu, käytä järjestelmäfonttia
            signatureFonts.push({
              name: "Järjestelmäfontti",
              font: "60px Arial, sans-serif",
            });
          }

          console.log("Fonts loaded successfully:", signatureFonts);

          // Alusta karuselli vasta kun fontit on ladattu
          await initializeCarousel();

          // Tarkista onko käyttäjällä jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          console.error("Error loading fonts:", error);
          // Virhetilanteessa alusta karuselli järjestelmäfontilla
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "Järjestelmäfontti",
            font: "60px Arial, sans-serif",
          });
          initializeCarousel();
        }
      }

      // Käynnistä fonttien lataus ja alustus
      async function initialize() {
        // Tallenna IP-osoite heti alussa
        await saveSessionId();
        await loadFontsAndInitialize();

        // Tarkista maksun tila ensin
        await checkPaymentStatus();

        // Tarkista tila vasta kun IP on tallennettu
        await checkStatus();
      }

      // Käynnistä sovellus
      initialize();

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Tarkista maksun tila sivun latautuessa
      async function checkPaymentStatus() {
        // Tarkista onko maksu vanhentunut
        if (isPaymentExpired()) {
          console.log("⏰ Payment expired, deleting data...");
          await resetAllData();
          return;
        }

        if (getQueryParam("success") === "true") {
          console.log("✅ Payment successful, marking as paid...");

          // Tarkista onko maksu jo merkitty suoritetuksi
          const hasPaid = getPaymentStatus();

          // Merkitse maksu onnistuneeksi heti localStorageen, jos ei ole jo merkitty
          if (!hasPaid) {
            savePaymentStatus(true);
            console.log("Payment status saved to localStorage: true");

            // Tallenna maksun aikaleima vain jos sitä ei ole jo asetettu
            if (!localStorage.getItem("paymentExpiry")) {
              savePaymentTimestamp();
            }

            // Nollaa automaattisen latauksen tila, jos käyttäjä on juuri maksanut
            localStorage.removeItem("hasAutoDownloaded");
          }

          // Tarkista tila heti
          checkStatus(true);
        } else if (getQueryParam("canceled") === "true") {
          console.log("❌ Payment canceled.");
          statusMessage.textContent = "Payment canceled.";
        }
      }

      // Lisää tapahtumankäsittelijä "Lataa uudelleen" -napille
      downloadAgainButton.addEventListener("click", async () => {
        await downloadSignatures();
      });

      // Tarkista tila säännöllisesti, mutta varmista että IP on haettu
      setTimeout(() => {
        setInterval(checkStatus, 2000);
        checkStatus();
      }, 1000);

      // Ajastimen muuttujat
      let resetTimerInterval;
      let resetTimeLeft = 180; // 3 minuuttia sekunteina

      // Funktio ajastimen päivittämiseen
      function updateResetTimer() {
        // Hae jäljellä oleva aika localStoragesta
        const expiryTime = localStorage.getItem("paymentExpiry");
        if (!expiryTime) {
          resetTimer.textContent =
            "Data will be automatically deleted in 3:00 minutes";
          return;
        }

        const now = Date.now();
        const timeLeft = Math.max(0, parseInt(expiryTime) - now);

        // Muunna millisekunnit minuuteiksi ja sekunneiksi
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);

        resetTimer.textContent = `Data will be automatically deleted in ${minutes}:${
          seconds < 10 ? "0" : ""
        }${seconds} minutes`;

        if (timeLeft <= 0) {
          clearInterval(resetTimerInterval);
          resetAllData();
        }
      }

      // Lisää tapahtumankäsittelijä "Luo lisää allekirjoituksia" -napille
      resetButton.addEventListener("click", resetAllData);

      // Tarkista onko sivu ladattu resetoinnin jälkeen
      if (getQueryParam("reset") === "true") {
        console.log("Page loaded after reset");
        // Poista reset-parametri URL:sta ilman sivun uudelleenlatausta
        const url = new URL(window.location);
        url.searchParams.delete("reset");
        window.history.replaceState({}, document.title, url);
      }

      // Lisää tapahtumankäsittelijä ostonapille
      buyButton.addEventListener("click", async () => {
        await createCheckoutSession();
      });

      // Varmista, että tarkistus suoritetaan säännöllisesti
      setTimeout(() => {
        // Tarkista tila heti kerran
        checkStatus();

        // Aseta ajastin tarkistamaan tila säännöllisesti
        setInterval(() => {
          checkStatus();
        }, 10000); // Tarkista 10 sekunnin välein
      }, 1000);

      // Lisää myös tarkistus sivun latautuessa
      window.addEventListener("load", () => {
        checkStatus();
      });

      // Lisää tarkistus myös kun sivu tulee takaisin näkyviin
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          checkStatus();
        }
      });
    </script>
  </body>
</html>
