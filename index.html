<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Allekirjoitusgeneraattori</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto 40px auto;
        overflow: hidden;
        position: relative;
      }

      .signature-carousel {
        display: flex;
        transition: transform 0.5s ease;
        gap: 30px;
        padding: 10px 100px;
      }

      .carousel-item {
        min-width: 250px;
        height: 150px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .carousel-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      @media (max-width: 1200px) {
        .carousel-item {
          min-width: calc(33.333% - 20px);
        }
      }

      @media (max-width: 900px) {
        .signature-carousel-container {
          margin-bottom: 30px;
        }

        .carousel-item {
          min-width: calc(50% - 20px);
          height: 120px;
        }
      }

      @media (max-width: 600px) {
        .carousel-item {
          min-width: calc(100% - 40px);
        }
      }

      /* Lisää oma fontti @font-face-säännöllä */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Allekirjoitusgeneraattori</h1>
    <p>Luo kauniita käsinkirjoitettuja allekirjoituksia helposti</p>

    <!-- Lisätään allekirjoituskaruselli -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <!-- Karusellin sisältö täytetään JavaScriptillä -->
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Kirjoita nimesi tähän..."
          style="width: 40%"
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Luo allekirjoitukset
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Osta allekirjoitukset (5€)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Haluatko allekirjoitukset myös sähköpostiisi?</h2>
      <input type="email" id="emailInput" placeholder="Sähköpostiosoitteesi" />
      <button id="sendEmailButton">Lähetä allekirjoitukset sähköpostiin</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <div
      id="download-again-container"
      class="email-container"
      style="display: none"
    >
      <button id="downloadAgainButton" class="button primary-button">
        Lataa allekirjoitukset uudelleen
      </button>
    </div>

    <div id="reset-container" class="email-container" style="display: none">
      <div id="reset-timer" class="status-message">
        Tiedot poistetaan automaattisesti 3:00 minuutin kuluttua
      </div>
      <button id="resetButton" class="button primary-button">
        Luo lisää allekirjoituksia
      </button>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");
      const downloadAgainContainer = document.getElementById(
        "download-again-container"
      );
      const downloadAgainButton = document.getElementById(
        "downloadAgainButton"
      );
      const resetContainer = document.getElementById("reset-container");
      const resetButton = document.getElementById("resetButton");
      const resetTimer = document.getElementById("reset-timer");

      // Fontit allekirjoituksille - alusta tyhjä lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Anna Virtanen",
        "Matti Korhonen",
        "Liisa Mäkinen",
        "Juha Nieminen",
        "Sari Laine",
        "Mikko Koskinen",
        "Tiina Järvinen",
      ];

      // Tallenna käyttäjän IP-osoite localStorageen
      async function saveClientIp() {
        try {
          const response = await fetch(`${API_URL}/api/get-client-ip`);
          const clientIp = await response.text();
          localStorage.setItem("clientIp", clientIp);
          console.log("IP tallennettu localStorageen:", clientIp);
          return clientIp;
        } catch (error) {
          console.error("Virhe IP:n tallennuksessa:", error);
          return null;
        }
      }

      // Hae tallennettu IP-osoite tai hae uusi
      async function getClientIp() {
        let clientIp = localStorage.getItem("clientIp");
        if (!clientIp) {
          clientIp = await saveClientIp();
        }
        return clientIp;
      }

      // Tallenna maksutila localStorageen
      function savePaymentStatus(isPaid) {
        localStorage.setItem("hasPaid", isPaid ? "true" : "false");
        console.log("Maksutila tallennettu localStorageen:", isPaid);
      }

      // Hae maksutila localStoragesta
      function getPaymentStatus() {
        return localStorage.getItem("hasPaid") === "true";
      }

      // Luo allekirjoitukset karuselliin
      async function initializeCarousel() {
        // Tyhjennä karuselli
        signatureCarousel.innerHTML = "";

        // Odota että fontit on ladattu
        await document.fonts.ready;

        // Varmista että käyttäjän IP on tallennettu
        await getClientIp();

        console.log("Alustetaan karuselli käyttäen backend-reittiä");

        // Luo esimerkkiallekirjoitukset ja lisää ne karuselliin
        const signatures = [];

        // Luo esimerkkiallekirjoitukset backendissä
        try {
          // Luo allekirjoitukset jokaiselle esimerkkihenkilölle
          for (const name of exampleNames) {
            try {
              // Käytä samaa backend-reittiä kuin käyttäjän allekirjoituksille
              const response = await fetch(
                `${API_URL}/api/create-signature-for-carousel`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ name }),
                }
              );

              if (!response.ok) {
                throw new Error(
                  `Virhe allekirjoituksen luonnissa: ${response.status}`
                );
              }

              const data = await response.json();

              if (data.image) {
                signatures.push({
                  name,
                  image: data.image,
                  font: "Oma Fontti",
                });
              }
            } catch (error) {
              console.error(
                `Virhe esimerkkiallekirjoituksen luonnissa (${name}):`,
                error
              );
            }
          }

          // Jos ei saatu yhtään allekirjoitusta, näytä virheilmoitus
          if (signatures.length === 0) {
            const message = document.createElement("div");
            message.className = "carousel-item";
            message.textContent =
              "Esimerkkiallekirjoitusten luonti epäonnistui.";
            signatureCarousel.appendChild(message);
            return;
          }

          console.log(`Luotu ${signatures.length} esimerkkiallekirjoitusta`);

          // Lisää allekirjoitukset karuselliin
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Lisää samat allekirjoitukset uudelleen, jotta karuselli näyttää jatkuvalta
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ympärille keskitystä varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Käynnistä karusellin animaatio
          startCarouselAnimation();
        } catch (error) {
          console.error("Virhe karusellin alustuksessa:", error);
          const message = document.createElement("div");
          message.className = "carousel-item";
          message.textContent = "Virhe esimerkkiallekirjoitusten luonnissa.";
          signatureCarousel.appendChild(message);
        }
      }

      // Karusellin animaatio
      let carouselPosition = 0;
      let carouselAnimationId;
      let isResetting = false;

      function startCarouselAnimation() {
        if (carouselAnimationId) {
          cancelAnimationFrame(carouselAnimationId);
        }

        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const totalItems = items.length;
        const visibleItems = 3; // Näkyvien elementtien määrä
        const itemWidth = 280; // Elementin leveys + marginaali
        const duration = 10000; // Koko kierroksen kesto millisekunteina
        const step = ((itemWidth * exampleNames.length) / duration) * 16.7; // Siirtymä per frame
        const containerWidth = document.querySelector(
          ".signature-carousel-container"
        ).offsetWidth;

        // Aseta alkuposition niin, että ensimmäinen elementti on näkyvissä
        carouselPosition = 0;

        function animateCarousel() {
          if (!isResetting) {
            carouselPosition -= step;

            // Kun karuselli on liikkunut tarpeeksi, valmistele paluu alkuun
            // Tarkistetaan onko ensimmäinen "aito" elementti liikkunut pois näkyvistä
            if (carouselPosition <= -itemWidth * exampleNames.length) {
              isResetting = true;

              // Poista transition väliaikaisesti
              signatureCarousel.style.transition = "none";

              // Aseta timeout, jotta transition-muutos ehtii vaikuttaa
              setTimeout(() => {
                // Nollaa positio
                carouselPosition = 0;
                signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

                // Palauta transition pienen viiveen jälkeen
                setTimeout(() => {
                  signatureCarousel.style.transition = "transform 0.5s ease";
                  isResetting = false;
                }, 20);
              }, 20);
            }
          }

          // Päivitä karusellin sijainti
          if (!isResetting) {
            signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

            // Päivitä elementtien läpinäkyvyys sijainnin perusteella
            updateItemsOpacity(containerWidth);
          }

          carouselAnimationId = requestAnimationFrame(animateCarousel);
        }

        carouselAnimationId = requestAnimationFrame(animateCarousel);
      }

      // Päivitä elementtien läpinäkyvyys
      function updateItemsOpacity(containerWidth) {
        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const fadeZone = 200; // Häivytysvyöhykkeen leveys

        items.forEach((item) => {
          const rect = item.getBoundingClientRect();
          const containerRect =
            signatureCarousel.parentElement.getBoundingClientRect();

          // Laske etäisyys vasemmasta ja oikeasta reunasta
          const distanceFromLeft = rect.left - containerRect.left;
          const distanceFromRight = containerRect.right - rect.right;

          // Laske läpinäkyvyys etäisyyden perusteella
          let opacity = 1;
          let scale = 1;

          if (distanceFromLeft < fadeZone) {
            opacity = distanceFromLeft / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          } else if (distanceFromRight < fadeZone) {
            opacity = distanceFromRight / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          }

          // Rajoita läpinäkyvyys välille 0-1 ja aseta se
          opacity = Math.max(0.1, Math.min(1, opacity));
          item.style.opacity = opacity;
          item.style.transform = `scale(${scale})`;
        });
      }

      // Luo allekirjoitukset
      async function createSignatures() {
        const name = nameInput.value.trim();
        const color = document.querySelector(
          'input[name="color"]:checked'
        ).value;
        const clientIp = await getClientIp();

        if (!name) {
          alert("Syötä nimesi ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, color, clientIp }),
          });

          if (!response.ok) {
            throw new Error(
              `Virhe allekirjoituksen luonnissa: ${response.status}`
            );
          }

          const data = await response.json();

          // Näytä allekirjoitukset
          signaturesContainer.innerHTML = "";
          data.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${name} allekirjoitus`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // Näytä ostonappi
          buyButton.style.display = "inline-block";

          // Näytä viesti
          statusMessage.textContent = "Allekirjoitukset luotu onnistuneesti!";
          statusMessage.style.color = "#4CAF50"; // Vihreä väri
        } catch (error) {
          console.error("Virhe allekirjoitusten luonnissa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten luonnissa.";
          statusMessage.style.color = "#f44336"; // Punainen väri
        }
      }

      // Lisää tapahtumankäsittelijä painikkeelle
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Tarkista onko käyttäjällä jo allekirjoituksia
      async function checkExistingSignatures() {
        const clientIp = await getClientIp();

        // Jos paikallisesta tallennustilasta ei löydy, tarkista palvelimelta
        fetch(`${API_URL}/api/get-signatures?clientIp=${clientIp}`)
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Ei allekirjoituksia");
          })
          .then((data) => {
            // Tarkista, että data on oikeassa muodossa ja sisältää kuvia
            if (
              data &&
              data.images &&
              Array.isArray(data.images) &&
              data.images.length > 0 &&
              data.name // Varmista että nimikentässä on arvo
            ) {
              console.log("Löydettiin aiemmat allekirjoitukset:", data);

              // Näytä tallennetut allekirjoitukset
              signaturesContainer.innerHTML = "";
              data.images.forEach((imageData) => {
                const signatureItem = document.createElement("div");
                signatureItem.className = "signature-item";

                const img = document.createElement("img");
                img.src = imageData;
                img.alt = `${data.name} allekirjoitus`;

                signatureItem.appendChild(img);
                signaturesContainer.appendChild(signatureItem);
              });

              // Aseta nimi kenttään, mutta vain jos kenttä on tyhjä
              if (nameInput.value.trim() === "" && data.name) {
                nameInput.value = data.name;
              }

              // Näytä selkeä viesti käyttäjälle
              statusMessage.textContent = `Aiemmin luodut allekirjoitukset (${data.name}) ladattu.`;
              statusMessage.style.color = "#4CAF50"; // Vihreä väri

              // Näytä ostonappi
              buyButton.style.display = "inline-block";
            } else {
              console.log(
                "Ei aiempia allekirjoituksia tai data on virheellinen:",
                data
              );
              // Tyhjennä allekirjoituskontti
              signaturesContainer.innerHTML = "";
              // Piilota ostonappi
              buyButton.style.display = "none";
              // Tyhjennä statusviesti
              statusMessage.textContent = "";
            }
          })
          .catch((error) => {
            console.log("Ei aiempia allekirjoituksia:", error);
            // Tyhjennä allekirjoituskontti
            signaturesContainer.innerHTML = "";
            // Piilota ostonappi
            buyButton.style.display = "none";
            // Tyhjennä statusviesti
            statusMessage.textContent = "";
          });
      }

      // Tarkista tila
      async function checkStatus(autoDownload = true) {
        // Varmista että IP on haettu ennen tilan tarkistusta
        const clientIp = await getClientIp();
        console.log("Tarkistetaan tila IP:lle:", clientIp);

        try {
          const response = await fetch(
            `${API_URL}/api/check-signatures?clientIp=${clientIp}`
          );
          const data = await response.json();

          // Tarkista localStoragesta maksutila ja yhdistä se palvelimen tietoihin
          const localPaymentStatus = getPaymentStatus();

          // Jos joko palvelin tai localStorage sanoo että on maksettu, käsitellään maksettuna
          if (localPaymentStatus && !data.hasPaid) {
            console.log(
              "Maksutila löytyi localStoragesta mutta ei palvelimelta, käytetään localStoragen tietoa"
            );
            data.hasPaid = true;
            data.canDownload = data.hasSignatures && data.hasPaid;
          }

          // Tallenna maksutila localStorageen jos se on muuttunut
          if (data.hasPaid) {
            savePaymentStatus(true);
          }

          console.log("Tila päivitetty:", data);

          if (data.hasSignatures) {
            if (data.hasPaid && data.canDownload) {
              console.log("Maksu vahvistettu, allekirjoitukset ladattavissa");
              statusMessage.textContent =
                "Maksu onnistui! Allekirjoitukset ladattavissa.";
              statusMessage.style.color = "#4CAF50"; // Vihreä väri
              buyButton.style.display = "none";

              // Näytä "Lataa uudelleen" -nappi
              downloadAgainContainer.style.display = "block";

              // Näytä sähköpostikenttä
              emailContainer.style.display = "block";

              // Näytä reset-container ja käynnistä ajastin
              resetContainer.style.display = "block";

              // Käynnistä ajastin vain jos sitä ei ole jo käynnistetty
              if (!resetTimerInterval) {
                resetTimeLeft = 180; // 3 minuuttia
                updateResetTimer(); // Päivitä heti kerran
                resetTimerInterval = setInterval(updateResetTimer, 1000);
              }

              // Tarkista onko automaattinen lataus jo suoritettu
              const hasAutoDownloaded =
                localStorage.getItem("hasAutoDownloaded");

              if (autoDownload && !hasAutoDownloaded) {
                // Merkitse automaattinen lataus suoritetuksi
                localStorage.setItem("hasAutoDownloaded", "true");

                // Viive ennen latausta, jotta käyttäjä näkee viestin
                setTimeout(() => {
                  downloadSignatures();
                }, 1000);
              }
            } else {
              // Näytä viesti vain jos käyttäjä on luonut allekirjoitukset
              if (signaturesContainer.innerHTML.trim() !== "") {
                statusMessage.textContent = "Allekirjoitukset luotu!";
                statusMessage.style.color = "#6e8efb"; // Sininen väri
                buyButton.style.display = "inline-block";

                // Piilota "Lataa uudelleen" -nappi ja reset-container
                downloadAgainContainer.style.display = "none";
                resetContainer.style.display = "none";

                // Pysäytä ajastin
                if (resetTimerInterval) {
                  clearInterval(resetTimerInterval);
                  resetTimerInterval = null;
                }
              }
            }
          } else if (data.hasPaid) {
            // Jos maksu on suoritettu mutta allekirjoituksia ei löydy, yritä hakea ne
            console.log(
              "Maksu löytyy mutta allekirjoituksia ei, yritetään hakea..."
            );
            await checkExistingSignatures();
            // Tarkista tila uudelleen pienen viiveen jälkeen
            setTimeout(() => checkStatus(autoDownload), 500);
          } else {
            // Ei allekirjoituksia, piilota ostonappi
            buyButton.style.display = "none";
            statusMessage.textContent = "";

            // Piilota "Lataa uudelleen" -nappi ja reset-container
            downloadAgainContainer.style.display = "none";
            resetContainer.style.display = "none";

            // Pysäytä ajastin
            if (resetTimerInterval) {
              clearInterval(resetTimerInterval);
              resetTimerInterval = null;
            }
          }
        } catch (error) {
          console.error("Virhe tilan tarkistuksessa:", error);
          statusMessage.textContent = "Virhe tilan tarkistuksessa.";
        }
      }

      // Lataa allekirjoitukset
      async function downloadSignatures() {
        const clientIp = await getClientIp();
        window.location.href = `${API_URL}/api/download-signatures?clientIp=${clientIp}`;
      }

      // Osta-painikkeen toiminnallisuus
      buyButton.addEventListener("click", async () => {
        try {
          const clientIp = await getClientIp();
          const response = await fetch(`${API_URL}/api/create-payment`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ clientIp }),
          });
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          console.error("Virhe maksun luonnissa:", error);
          statusMessage.textContent = "Virhe maksun käsittelyssä.";
        }
      });

      // Sähköpostin lähetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const clientIp = await getClientIp();

        if (!email) {
          alert("Syötä sähköpostiosoite ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, clientIp }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Allekirjoitukset lähetetty sähköpostiisi!");
          } else {
            alert("Virhe sähköpostin lähetyksessä.");
          }

          // Estä napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `Voit lähettää sähköpostin uudelleen ${timeLeft} sekunnin kuluttua.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Virhe sähköpostin lähetyksessä:", error);
          alert("Virhe sähköpostin lähetyksessä.");
        }
      });

      // Lataa oma fontti dynaamisesti ja alusta karuselli vasta kun fontti on ladattu
      async function loadFontsAndInitialize() {
        try {
          // Tyhjennä fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lisää oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });

            console.log("Oma fontti ladattu onnistuneesti!");
          } catch (fontError) {
            console.error("Virhe oman fontin latauksessa:", fontError);
            // Jos oman fontin lataus epäonnistuu, käytä järjestelmäfonttia
            signatureFonts.push({
              name: "Järjestelmäfontti",
              font: "60px Arial, sans-serif",
            });
          }

          console.log("Fontit ladattu onnistuneesti:", signatureFonts);

          // Alusta karuselli vasta kun fontit on ladattu
          await initializeCarousel();

          // Tarkista onko käyttäjällä jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          console.error("Virhe fonttien latauksessa:", error);
          // Virhetilanteessa alusta karuselli järjestelmäfontilla
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "Järjestelmäfontti",
            font: "60px Arial, sans-serif",
          });
          initializeCarousel();
        }
      }

      // Käynnistä fonttien lataus ja alustus
      async function initialize() {
        // Tallenna IP-osoite heti alussa
        await saveClientIp();
        await loadFontsAndInitialize();
        // Tarkista maksun tila vasta kun IP on tallennettu
        await checkStatus();
      }

      // Käynnistä sovellus
      initialize();

      // Tarkista URL-parametrit sivun latautuessa
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Tarkista maksun tila sivun latautuessa
      async function checkPaymentStatus() {
        if (getQueryParam("success") === "true") {
          console.log("✅ Maksu onnistui, tarkistetaan tila...");

          // Merkitse maksu onnistuneeksi heti localStorageen
          savePaymentStatus(true);

          // Nollaa automaattisen latauksen tila, jos käyttäjä on juuri maksanut
          localStorage.removeItem("hasAutoDownloaded");

          // Varmista että IP on haettu ennen tilan tarkistusta
          await getClientIp();
          // Odota hetki että backend ehtii käsitellä maksun
          setTimeout(() => checkStatus(true), 1000);
        } else if (getQueryParam("canceled") === "true") {
          console.log("❌ Maksu peruutettu.");
          statusMessage.textContent = "Maksu peruutettiin.";
        }
      }

      // Lisää tapahtumankäsittelijä "Lataa uudelleen" -napille
      downloadAgainButton.addEventListener("click", async () => {
        await downloadSignatures();
      });

      // Tarkista tila säännöllisesti, mutta varmista että IP on haettu
      setTimeout(() => {
        setInterval(checkStatus, 2000);
        checkStatus();
      }, 1000);

      // Ajastimen muuttujat
      let resetTimerInterval;
      let resetTimeLeft = 180; // 3 minuuttia sekunteina

      // Funktio ajastimen päivittämiseen
      function updateResetTimer() {
        const minutes = Math.floor(resetTimeLeft / 60);
        const seconds = resetTimeLeft % 60;
        resetTimer.textContent = `Tiedot poistetaan automaattisesti ${minutes}:${
          seconds < 10 ? "0" : ""
        }${seconds} minuutin kuluttua`;

        if (resetTimeLeft <= 0) {
          clearInterval(resetTimerInterval);
          resetAllData();
        }
        resetTimeLeft--;
      }

      // Funktio kaikkien tietojen tyhjentämiseen
      async function resetAllData() {
        // Tyhjennä localStorage
        localStorage.removeItem("clientIp");
        localStorage.removeItem("hasAutoDownloaded");
        localStorage.removeItem("hasPaid");

        // Tyhjennä allekirjoitukset
        signaturesContainer.innerHTML = "";

        // Tyhjennä nimi
        nameInput.value = "";

        // Piilota napit ja viestit
        buyButton.style.display = "none";
        downloadAgainContainer.style.display = "none";
        emailContainer.style.display = "none";
        resetContainer.style.display = "none";

        // Näytä viesti
        statusMessage.textContent = "Tiedot poistettu. Ohjataan etusivulle...";
        statusMessage.style.color = "#4CAF50"; // Vihreä väri

        // Pysäytä ajastin
        if (resetTimerInterval) {
          clearInterval(resetTimerInterval);
        }

        // Hae uusi IP-osoite
        await saveClientIp();

        // Pieni viive ennen ohjausta etusivulle
        setTimeout(() => {
          // Ohjaa käyttäjä etusivulle
          window.location.href =
            window.location.origin + window.location.pathname;
        }, 1500);
      }

      // Lisää tapahtumankäsittelijä "Luo lisää allekirjoituksia" -napille
      resetButton.addEventListener("click", resetAllData);
    </script>
  </body>
</html>
