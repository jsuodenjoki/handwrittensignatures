<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Allekirjoitusgeneraattori</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        max-width: 1100px;
        margin: 30px auto;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow-x: hidden;
      }

      .gradient-bg {
        position: absolute;
        top: -30%;
        left: 30%;
        width: 120%;
        height: 150%;
        transform: translateX(-50%) rotate(30deg);
        background: radial-gradient(
          circle,
          rgba(37, 99, 235, 0.6) 0%,
          rgba(30, 64, 175, 0.4) 50%,
          rgba(0, 0, 0, 0) 100%
        );
        filter: blur(150px);
        opacity: 0.4;
        z-index: -1;
      }

      .container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        max-width: 800px;
        padding: 30px;
        margin: 50px auto;
        border-radius: 12px;
        box-shadow: 0px 8px 20px rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .container:hover {
        transform: scale(1.02);
        box-shadow: 0px 10px 25px rgba(255, 255, 255, 0.2);
      }

      h1 {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 18px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin-bottom: 15px;
      }

      .button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        margin: 10px 5px;
      }

      .primary-button {
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      .primary-button:hover {
        transform: scale(1.05);
        box-shadow: 0px 6px 15px rgba(110, 142, 251, 0.5);
      }

      .buy-button {
        display: none;
        background: linear-gradient(90deg, #4caf50, #388e3c);
        color: white;
        box-shadow: 0px 4px 10px rgba(76, 175, 80, 0.3);
      }

      .buy-button:hover {
        background: linear-gradient(90deg, #45a049, #2e7d32);
        box-shadow: 0px 6px 15px rgba(76, 175, 80, 0.5);
        transform: scale(1.05);
      }

      .status-message {
        margin-top: 15px;
        font-weight: bold;
        color: #6e8efb;
      }

      .signatures-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .signature-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        width: 300px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signature-item img {
        max-width: 100%;
        max-height: 100%;
      }

      .email-container {
        text-align: center;
        margin-top: 30px;
        display: none;
      }

      .email-container h2 {
        font-size: 20px;
        color: white;
        margin-bottom: 15px;
      }

      #emailInput {
        width: 80%;
        max-width: 400px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: 1px solid #ccc;
        outline: none;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      #emailInput:focus {
        border-color: #6e8efb;
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #sendEmailButton {
        margin-top: 15px;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        background: linear-gradient(90deg, #6e8efb, #a777e3);
        color: white;
        transition: all 0.3s ease;
      }

      #sendEmailButton:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 10px rgba(110, 142, 251, 0.3);
      }

      #emailTimer {
        margin-top: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        .gradient-bg {
          top: -10%;
          height: 50vh;
          filter: blur(20px);
          opacity: 0.2;
          width: 80vw;
        }

        .container {
          transform: none !important;
          padding: 20px;
        }

        .signatures-container {
          flex-direction: column;
          align-items: center;
        }

        .signature-item {
          width: 90%;
        }
      }

      /* Karusellin tyylit */
      .signature-carousel-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto 40px auto;
        overflow: hidden;
        position: relative;
      }

      .signature-carousel {
        display: flex;
        transition: transform 0.5s ease;
        gap: 30px;
        padding: 10px 100px;
      }

      .carousel-item {
        min-width: 250px;
        height: 150px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .carousel-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      @media (max-width: 1200px) {
        .carousel-item {
          min-width: calc(33.333% - 20px);
        }
      }

      @media (max-width: 900px) {
        .signature-carousel-container {
          margin-bottom: 30px;
        }

        .carousel-item {
          min-width: calc(50% - 20px);
          height: 120px;
        }
      }

      @media (max-width: 600px) {
        .carousel-item {
          min-width: calc(100% - 40px);
        }
      }

      /* Lis√§√§ oma fontti @font-face-s√§√§nn√∂ll√§ */
      @font-face {
        font-family: "OmaFontti1";
        src: url("/fonts/omafontti1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .color-options {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .color-circle {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        border: 2px solid #fff;
      }

      .color-circle.black {
        background-color: black;
      }

      .color-circle.blue {
        background-color: blue;
      }

      .color-options input[type="radio"] {
        display: none;
      }

      .color-options input[type="radio"]:checked + .color-circle {
        border: 2px solid #6e8efb;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <h1>Allekirjoitusgeneraattori</h1>
    <p>Luo kauniita k√§sinkirjoitettuja allekirjoituksia helposti</p>

    <!-- Lis√§t√§√§n allekirjoituskaruselli -->
    <div class="signature-carousel-container">
      <div class="signature-carousel">
        <!-- Karusellin sis√§lt√∂ t√§ytet√§√§n JavaScriptill√§ -->
      </div>
    </div>

    <div class="container">
      <div class="input-group">
        <input
          type="text"
          id="nameInput"
          placeholder="Kirjoita nimesi t√§h√§n..."
          style="width: 40%"
        />
      </div>

      <div class="color-options">
        <label>
          <input type="radio" name="color" value="black" checked />
          <span class="color-circle black"></span>
        </label>
        <label>
          <input type="radio" name="color" value="blue" />
          <span class="color-circle blue"></span>
        </label>
      </div>

      <button id="generateSignatures" class="button primary-button">
        Luo allekirjoitukset
      </button>

      <div id="statusMessage" class="status-message"></div>

      <div id="signaturesContainer" class="signatures-container"></div>

      <button id="buyButton" class="button buy-button">
        Osta allekirjoitukset (5‚Ç¨)
      </button>
    </div>

    <div id="email-container" class="email-container">
      <h2>Haluatko allekirjoitukset my√∂s s√§hk√∂postiisi?</h2>
      <input type="email" id="emailInput" placeholder="S√§hk√∂postiosoitteesi" />
      <button id="sendEmailButton">L√§het√§ allekirjoitukset s√§hk√∂postiin</button>
      <div id="emailTimer" class="hidden"></div>
    </div>

    <script>
      const API_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : window.location.origin;

      console.log("API_URL asetettu:", API_URL);

      // DOM-elementit
      const nameInput = document.getElementById("nameInput");
      const generateSignaturesButton =
        document.getElementById("generateSignatures");
      const signaturesContainer = document.getElementById(
        "signaturesContainer"
      );
      const buyButton = document.getElementById("buyButton");
      const statusMessage = document.getElementById("statusMessage");
      const emailContainer = document.getElementById("email-container");
      const emailInput = document.getElementById("emailInput");
      const sendEmailButton = document.getElementById("sendEmailButton");
      const emailTimer = document.getElementById("emailTimer");
      const signatureCarousel = document.querySelector(".signature-carousel");

      // Fontit allekirjoituksille - alusta tyhj√§ lista
      const signatureFonts = [];

      // Esimerkkinimet karuselliin
      const exampleNames = [
        "Anna Virtanen",
        "Matti Korhonen",
        "Liisa M√§kinen",
        "Juha Nieminen",
        "Sari Laine",
        "Mikko Koskinen",
        "Tiina J√§rvinen",
      ];

      // Luo allekirjoitukset karuselliin
      async function initializeCarousel() {
        // Tyhjenn√§ karuselli
        signatureCarousel.innerHTML = "";

        // Odota ett√§ fontit on ladattu
        await document.fonts.ready;

        console.log("Alustetaan karuselli k√§ytt√§en backend-reitti√§");

        // Luo esimerkkiallekirjoitukset ja lis√§√§ ne karuselliin
        const signatures = [];

        // Luo esimerkkiallekirjoitukset backendiss√§
        try {
          // Luo allekirjoitukset jokaiselle esimerkkihenkil√∂lle
          for (const name of exampleNames) {
            try {
              // K√§yt√§ samaa backend-reitti√§ kuin k√§ytt√§j√§n allekirjoituksille
              const response = await fetch(
                `${API_URL}/api/create-signature-for-carousel`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ name }),
                }
              );

              if (!response.ok) {
                throw new Error(
                  `Virhe allekirjoituksen luonnissa: ${response.status}`
                );
              }

              const data = await response.json();

              if (data.image) {
                signatures.push({
                  name,
                  image: data.image,
                  font: "Oma Fontti",
                });
              }
            } catch (error) {
              console.error(
                `Virhe esimerkkiallekirjoituksen luonnissa (${name}):`,
                error
              );
            }
          }

          // Jos ei saatu yht√§√§n allekirjoitusta, n√§yt√§ virheilmoitus
          if (signatures.length === 0) {
            const message = document.createElement("div");
            message.className = "carousel-item";
            message.textContent =
              "Esimerkkiallekirjoitusten luonti ep√§onnistui.";
            signatureCarousel.appendChild(message);
            return;
          }

          console.log(`Luotu ${signatures.length} esimerkkiallekirjoitusta`);

          // Lis√§√§ allekirjoitukset karuselliin
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ymp√§rille keskityst√§ varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // Lis√§√§ samat allekirjoitukset uudelleen, jotta karuselli n√§ytt√§√§ jatkuvalta
          for (const signature of signatures) {
            const carouselItem = document.createElement("div");
            carouselItem.className = "carousel-item";
            carouselItem.dataset.name = signature.name;

            // Luo div-elementti kuvan ymp√§rille keskityst√§ varten
            const imgContainer = document.createElement("div");
            imgContainer.style.width = "100%";
            imgContainer.style.height = "100%";
            imgContainer.style.display = "flex";
            imgContainer.style.alignItems = "center";
            imgContainer.style.justifyContent = "center";

            const img = document.createElement("img");
            img.src = signature.image;
            img.alt = `${signature.name} allekirjoitus (${signature.font})`;
            img.style.maxWidth = "100%";
            img.style.maxHeight = "100%";
            img.style.objectFit = "contain";

            imgContainer.appendChild(img);
            carouselItem.appendChild(imgContainer);
            signatureCarousel.appendChild(carouselItem);
          }

          // K√§ynnist√§ karusellin animaatio
          startCarouselAnimation();
        } catch (error) {
          console.error("Virhe karusellin alustuksessa:", error);
          const message = document.createElement("div");
          message.className = "carousel-item";
          message.textContent = "Virhe esimerkkiallekirjoitusten luonnissa.";
          signatureCarousel.appendChild(message);
        }
      }

      // Karusellin animaatio
      let carouselPosition = 0;
      let carouselAnimationId;
      let isResetting = false;

      function startCarouselAnimation() {
        if (carouselAnimationId) {
          cancelAnimationFrame(carouselAnimationId);
        }

        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const totalItems = items.length;
        const visibleItems = 3; // N√§kyvien elementtien m√§√§r√§
        const itemWidth = 280; // Elementin leveys + marginaali
        const duration = 10000; // Koko kierroksen kesto millisekunteina
        const step = ((itemWidth * exampleNames.length) / duration) * 16.7; // Siirtym√§ per frame
        const containerWidth = document.querySelector(
          ".signature-carousel-container"
        ).offsetWidth;

        // Aseta alkuposition niin, ett√§ ensimm√§inen elementti on n√§kyviss√§
        carouselPosition = 0;

        function animateCarousel() {
          if (!isResetting) {
            carouselPosition -= step;

            // Kun karuselli on liikkunut tarpeeksi, valmistele paluu alkuun
            // Tarkistetaan onko ensimm√§inen "aito" elementti liikkunut pois n√§kyvist√§
            if (carouselPosition <= -itemWidth * exampleNames.length) {
              isResetting = true;

              // Poista transition v√§liaikaisesti
              signatureCarousel.style.transition = "none";

              // Aseta timeout, jotta transition-muutos ehtii vaikuttaa
              setTimeout(() => {
                // Nollaa positio
                carouselPosition = 0;
                signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

                // Palauta transition pienen viiveen j√§lkeen
                setTimeout(() => {
                  signatureCarousel.style.transition = "transform 0.5s ease";
                  isResetting = false;
                }, 20);
              }, 20);
            }
          }

          // P√§ivit√§ karusellin sijainti
          if (!isResetting) {
            signatureCarousel.style.transform = `translateX(${carouselPosition}px)`;

            // P√§ivit√§ elementtien l√§pin√§kyvyys sijainnin perusteella
            updateItemsOpacity(containerWidth);
          }

          carouselAnimationId = requestAnimationFrame(animateCarousel);
        }

        carouselAnimationId = requestAnimationFrame(animateCarousel);
      }

      // P√§ivit√§ elementtien l√§pin√§kyvyys
      function updateItemsOpacity(containerWidth) {
        const items = signatureCarousel.querySelectorAll(".carousel-item");
        const fadeZone = 200; // H√§ivytysvy√∂hykkeen leveys

        items.forEach((item) => {
          const rect = item.getBoundingClientRect();
          const containerRect =
            signatureCarousel.parentElement.getBoundingClientRect();

          // Laske et√§isyys vasemmasta ja oikeasta reunasta
          const distanceFromLeft = rect.left - containerRect.left;
          const distanceFromRight = containerRect.right - rect.right;

          // Laske l√§pin√§kyvyys et√§isyyden perusteella
          let opacity = 1;
          let scale = 1;

          if (distanceFromLeft < fadeZone) {
            opacity = distanceFromLeft / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          } else if (distanceFromRight < fadeZone) {
            opacity = distanceFromRight / fadeZone;
            scale = 0.9 + 0.1 * opacity;
          }

          // Rajoita l√§pin√§kyvyys v√§lille 0-1 ja aseta se
          opacity = Math.max(0.1, Math.min(1, opacity));
          item.style.opacity = opacity;
          item.style.transform = `scale(${scale})`;
        });
      }

      // Luo allekirjoitukset
      async function createSignatures() {
        const name = nameInput.value.trim();
        const color = document.querySelector(
          'input[name="color"]:checked'
        ).value;

        if (!name) {
          alert("Sy√∂t√§ nimesi ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/create-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, color }),
          });

          if (!response.ok) {
            throw new Error(
              `Virhe allekirjoituksen luonnissa: ${response.status}`
            );
          }

          const data = await response.json();

          // N√§yt√§ allekirjoitukset
          signaturesContainer.innerHTML = "";
          data.images.forEach((imageData) => {
            const signatureItem = document.createElement("div");
            signatureItem.className = "signature-item";

            const img = document.createElement("img");
            img.src = imageData;
            img.alt = `${name} allekirjoitus`;

            signatureItem.appendChild(img);
            signaturesContainer.appendChild(signatureItem);
          });

          // N√§yt√§ ostonappi
          buyButton.style.display = "inline-block";

          // N√§yt√§ viesti
          statusMessage.textContent = "Allekirjoitukset luotu onnistuneesti!";
          statusMessage.style.color = "#4CAF50"; // Vihre√§ v√§ri
        } catch (error) {
          console.error("Virhe allekirjoitusten luonnissa:", error);
          statusMessage.textContent = "Virhe allekirjoitusten luonnissa.";
          statusMessage.style.color = "#f44336"; // Punainen v√§ri
        }
      }

      // Tarkista onko k√§ytt√§j√§ll√§ jo allekirjoituksia
      function checkExistingSignatures() {
        // Jos paikallisesta tallennustilasta ei l√∂ydy, tarkista palvelimelta
        fetch(`${API_URL}/api/get-signatures`)
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Ei allekirjoituksia");
          })
          .then((data) => {
            // Tarkista, ett√§ data on oikeassa muodossa ja sis√§lt√§√§ kuvia
            if (
              data &&
              data.images &&
              Array.isArray(data.images) &&
              data.images.length > 0 &&
              data.name // Varmista ett√§ nimikent√§ss√§ on arvo
            ) {
              console.log("L√∂ydettiin aiemmat allekirjoitukset:", data);

              // N√§yt√§ tallennetut allekirjoitukset
              signaturesContainer.innerHTML = "";
              data.images.forEach((imageData) => {
                const signatureItem = document.createElement("div");
                signatureItem.className = "signature-item";

                const img = document.createElement("img");
                img.src = imageData;
                img.alt = `${data.name} allekirjoitus`;

                signatureItem.appendChild(img);
                signaturesContainer.appendChild(signatureItem);
              });

              // Aseta nimi kentt√§√§n, mutta vain jos kentt√§ on tyhj√§
              if (nameInput.value.trim() === "" && data.name) {
                nameInput.value = data.name;
              }

              // N√§yt√§ selke√§ viesti k√§ytt√§j√§lle
              statusMessage.textContent = `Aiemmin luodut allekirjoitukset (${data.name}) ladattu.`;
              statusMessage.style.color = "#4CAF50"; // Vihre√§ v√§ri

              // N√§yt√§ ostonappi
              buyButton.style.display = "inline-block";
            } else {
              console.log(
                "Ei aiempia allekirjoituksia tai data on virheellinen:",
                data
              );
              // Tyhjenn√§ allekirjoituskontti
              signaturesContainer.innerHTML = "";
              // Piilota ostonappi
              buyButton.style.display = "none";
              // Tyhjenn√§ statusviesti
              statusMessage.textContent = "";
            }
          })
          .catch((error) => {
            console.log("Ei aiempia allekirjoituksia:", error);
            // Tyhjenn√§ allekirjoituskontti
            signaturesContainer.innerHTML = "";
            // Piilota ostonappi
            buyButton.style.display = "none";
            // Tyhjenn√§ statusviesti
            statusMessage.textContent = "";
          });
      }

      // Funktio allekirjoitusten l√§hett√§miseksi takaisin palvelimelle
      async function sendSignaturesToServer(data) {
        try {
          const response = await fetch(`${API_URL}/api/restore-signatures`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: data.name,
              images: data.images,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          console.log("Allekirjoitukset palautettu palvelimelle onnistuneesti");

          // Tarkista tila uudelleen
          checkStatus();
        } catch (error) {
          console.error(
            "Virhe allekirjoitusten palauttamisessa palvelimelle:",
            error
          );
        }
      }

      // Luo allekirjoitukset
      generateSignaturesButton.addEventListener("click", async () => {
        await createSignatures();
      });

      // Tarkista tila
      function checkStatus(autoDownload = true) {
        fetch(`${API_URL}/api/check-signatures`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Tila p√§ivitetty:", data);

            if (data.hasSignatures) {
              if (data.hasPaid && data.canDownload) {
                console.log("Maksu vahvistettu, ladataan allekirjoitukset...");
                statusMessage.textContent =
                  "Maksu onnistui! Allekirjoitukset ladataan...";
                statusMessage.style.color = "#4CAF50"; // Vihre√§ v√§ri
                buyButton.style.display = "none";

                if (autoDownload) {
                  // Viive ennen latausta, jotta k√§ytt√§j√§ n√§kee viestin
                  setTimeout(() => {
                    downloadSignatures();
                    emailContainer.style.display = "block";
                  }, 1000);
                }
              } else {
                // N√§yt√§ viesti vain jos k√§ytt√§j√§ on luonut allekirjoitukset
                if (signaturesContainer.innerHTML.trim() !== "") {
                  statusMessage.textContent = "Allekirjoitukset luotu!";
                  statusMessage.style.color = "#6e8efb"; // Sininen v√§ri
                  buyButton.style.display = "inline-block";
                }
              }
            } else {
              // Ei allekirjoituksia, piilota ostonappi
              buyButton.style.display = "none";
              statusMessage.textContent = "";
            }
          })
          .catch((error) => {
            console.error("Virhe tilan tarkistuksessa:", error);
            statusMessage.textContent = "Virhe tilan tarkistuksessa.";
          });
      }

      // Lataa allekirjoitukset
      function downloadSignatures() {
        window.location.href = `${API_URL}/api/download-signatures`;
      }

      // Osta-painikkeen toiminnallisuus
      buyButton.addEventListener("click", async () => {
        try {
          const response = await fetch(`${API_URL}/api/create-payment`, {
            method: "POST",
          });
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          console.error("Virhe maksun luonnissa:", error);
          statusMessage.textContent = "Virhe maksun k√§sittelyss√§.";
        }
      });

      // S√§hk√∂postin l√§hetys
      sendEmailButton.addEventListener("click", async () => {
        const email = emailInput.value.trim();

        if (!email) {
          alert("Sy√∂t√§ s√§hk√∂postiosoite ensin!");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/send-email`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            alert("Allekirjoitukset l√§hetetty s√§hk√∂postiisi!");
          } else {
            alert("Virhe s√§hk√∂postin l√§hetyksess√§.");
          }

          // Est√§ napin painaminen 60 sekunnin ajan
          sendEmailButton.disabled = true;
          let timeLeft = 60;

          emailTimer.textContent = `Voit l√§hett√§√§ s√§hk√∂postin uudelleen ${timeLeft} sekunnin kuluttua.`;
          emailTimer.classList.remove("hidden");

          const timerInterval = setInterval(() => {
            timeLeft--;
            emailTimer.textContent = `Voit l√§hett√§√§ s√§hk√∂postin uudelleen ${timeLeft} sekunnin kuluttua.`;

            if (timeLeft === 0) {
              clearInterval(timerInterval);
              emailTimer.classList.add("hidden");
              sendEmailButton.disabled = false;
            }
          }, 1000);
        } catch (error) {
          console.error("Virhe s√§hk√∂postin l√§hetyksess√§:", error);
          alert("Virhe s√§hk√∂postin l√§hetyksess√§.");
        }
      });

      // Lataa oma fontti dynaamisesti ja alusta karuselli vasta kun fontti on ladattu
      async function loadFontsAndInitialize() {
        try {
          // Tyhjenn√§ fonttilistaus ensin
          signatureFonts.length = 0;

          // Lataa vain oma fontti
          try {
            const fontFace = new FontFace(
              "OmaFontti1",
              `url(/fonts/omafontti1.ttf)`
            );

            const loadedFace = await fontFace.load();
            document.fonts.add(loadedFace);

            // Lis√§√§ oma fontti fonttilistaan suuremmalla fonttikoolla
            signatureFonts.push({
              name: "Oma Fontti",
              font: "100px 'OmaFontti1', cursive",
            });

            console.log("Oma fontti ladattu onnistuneesti!");
          } catch (fontError) {
            console.error("Virhe oman fontin latauksessa:", fontError);
            // Jos oman fontin lataus ep√§onnistuu, k√§yt√§ j√§rjestelm√§fonttia
            signatureFonts.push({
              name: "J√§rjestelm√§fontti",
              font: "60px Arial, sans-serif",
            });
          }

          console.log("Fontit ladattu onnistuneesti:", signatureFonts);

          // Alusta karuselli vasta kun fontit on ladattu
          await initializeCarousel();

          // Tarkista onko k√§ytt√§j√§ll√§ jo allekirjoituksia
          checkExistingSignatures();
        } catch (error) {
          console.error("Virhe fonttien latauksessa:", error);
          // Virhetilanteessa alusta karuselli j√§rjestelm√§fontilla
          signatureFonts.length = 0;
          signatureFonts.push({
            name: "J√§rjestelm√§fontti",
            font: "60px Arial, sans-serif",
          });
          initializeCarousel();
        }
      }

      // K√§ynnist√§ fonttien lataus ja alustus
      loadFontsAndInitialize();

      // Tarkista fonttitiedostojen saatavuus
      async function checkFontAvailability() {
        const fontPaths = [
          "./fonts/omafontti1.ttf",
          "/fonts/omafontti1.ttf",
          "../public/fonts/omafontti1.ttf",
        ];

        for (const path of fontPaths) {
          try {
            const response = await fetch(path, { method: "HEAD" });
            console.log(
              `Fonttitiedoston tarkistus (${path}): ${response.status}`
            );
          } catch (error) {
            console.error(
              `Virhe fonttitiedoston tarkistuksessa (${path}):`,
              error
            );
          }
        }
      }

      // Suorita tarkistus
      checkFontAvailability();

      // Tarkista URL-parametrit sivun latautuessa
      const sessionId = getQueryParam("session_id"); // üîπ Hae session ID URL:st√§

      if (sessionId) {
        console.log(`üîç Tarkistetaan maksu sessionId: ${sessionId}`);
        fetch(`${API_URL}/api/check-payment/${sessionId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.status === "paid") {
              console.log(
                "‚úÖ Maksu vahvistettu, tarkistetaan allekirjoitukset..."
              );
              checkStatus(true); // üîπ Automaattinen lataus k√§ynnistyy
            }
          })
          .catch((error) =>
            console.error("‚ùå Virhe maksun tarkistuksessa:", error)
          );
      }

      // Tarkista tila s√§√§nn√∂llisesti
      setInterval(checkStatus, 2000);
      checkStatus();
    </script>
  </body>
</html>
